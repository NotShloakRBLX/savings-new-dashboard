<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bank • Savings & Checking (Demo)</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#161616; --panel2:#111; --border:rgba(255,255,255,.12);
    --muted:rgba(255,255,255,.62); --text:#fff; --shadow:0 16px 40px rgba(0,0,0,.45);
    --tile:rgba(255,255,255,.06); --tileBorder:rgba(255,255,255,.10);
    --radius:18px; --t:.28s cubic-bezier(.2,.8,.2,1);
    --green:#1e7f4b; --green-2:#0f5f37; --red:#b73a3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#000;color:var(--text);
       font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
       -webkit-font-smoothing:antialiased}
  .app{max-width:430px;height:100svh;margin:0 auto;position:relative;overflow:hidden;background:var(--bg)}
  .views{display:flex;width:400%;height:100%;transition:transform var(--t)}
  .view{width:100%;height:100%;overflow:auto;padding-bottom:24px;background:linear-gradient(#0b0b0b,#0a0a0a 56%,#090909)}
  .view::-webkit-scrollbar{width:0;height:0}

  /* Top nav */
  .nav{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;
       padding:18px 14px 12px;
       background:linear-gradient(180deg,rgba(10,10,10,.96),rgba(10,10,10,.58) 45%,transparent);
       -webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}
  .nav h1{margin:0;font-size:42px;line-height:.98;font-weight:900;letter-spacing:-.6px}
  .iconrow{display:flex;gap:10px}
  .iconbtn{width:36px;height:36px;border-radius:999px;background:rgba(255,255,255,.06);
           border:1px solid rgba(255,255,255,.14);display:grid;place-items:center;transition:transform var(--t)}
  .iconbtn:active{transform:scale(.96)}
  .content{padding:8px 12px 28px}

  /* Cards & tiles */
  .card{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:16px 18px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 8px;color:var(--muted);font-size:15px}
  .balance{font-size:44px;font-weight:900;letter-spacing:-.5px}
  .apyPill{margin-left:auto;border:1px solid var(--border);background:rgba(255,255,255,.06);
           border-radius:999px;padding:8px 14px;font-weight:900}
  .row2{display:flex;gap:16px;margin-top:14px}
  .btn{flex:1;border-radius:18px;padding:16px 18px;border:1px solid var(--border);background:rgba(255,255,255,.06);font-weight:900}
  .btn.primary{background:#fff;color:#000}
  .fullBtn{display:block;width:100%;margin-top:14px;border-radius:18px;padding:16px 18px;border:1px solid var(--border);
           background:#fff;color:#000;font-weight:900}
  .tile{background:var(--tile);border:1px solid var(--tileBorder);border-radius:18px;padding:14px 16px}
  .tileRow{display:flex;justify-content:space-between;align-items:center}
  .label{color:var(--muted);font-weight:700}
  .big{font-weight:900}

  #svSend
  #ckSend{
    font-size: 18px;
    line-height: 1.1;
    padding: 18px 20px;
  }

  /* Account info dropdown */
  .acctInfo{overflow:hidden;max-height:0;opacity:.0;transition:max-height var(--t),opacity var(--t);margin:0 2px}
  .acctInfo.open{max-height:180px;opacity:1}
  .mini{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;margin-top:10px;
        border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--tileBorder);font-weight:800}

  /* Transactions list */
  .sectionTitle{margin:18px 6px 10px;font-size:26px;font-weight:900;letter-spacing:-.2px}
  .empty{padding:18px;border-radius:18px;border:1px dashed var(--tileBorder);text-align:center;color:var(--muted);background:rgba(255,255,255,.03)}
  .list .row{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,.04);
             border:1px solid rgba(255,255,255,.09);border-radius:16px;padding:12px 14px}
  .list .row + .row{margin-top:10px}
  .rMain{flex:1}
  .rTitle{font-weight:900}
  .rSub{color:var(--muted);font-size:12px}
  .rAmt{font-weight:900}

  /* Views positions: 4 views [savings, checking, transfer, txnDetails] */
  .pos-0 .views{transform:translateX(0)}         /* Savings */
  .pos-1 .views{transform:translateX(-25%)}      /* Checking */
  .pos-2 .views{transform:translateX(-50%)}      /* Pay/Transfer */
  .pos-3 .views{transform:translateX(-75%)}      /* Txn details */

  /* Transaction details view */
  .backPill{display:block;margin:14px auto 10px;width:92%;max-width:390px;padding:12px 18px;text-align:center;
            border-radius:999px;border:1px solid var(--tileBorder);background:rgba(255,255,255,.06);font-weight:900}
  .txnHeader{padding:14px 18px 10px;text-align:center}
  .txnAmount{font-size:64px;font-weight:900;letter-spacing:-.6px}
  .txnTitle{color:var(--muted);font-size:24px;font-weight:800;margin-top:4px}
  .txnDate{color:var(--muted);margin-top:6px}
  .rowD{margin:14px 12px;display:flex;justify-content:space-between;align-items:center;padding:16px;
        background:var(--tile);border:1px solid var(--tileBorder);border-radius:18px}
  .danger{display:block;width:92%;max-width:390px;margin:14px auto;padding:16px 20px;border-radius:16px;
          background:rgba(183,58,58,.15);border:1px solid rgba(183,58,58,.4);color:#fff;font-weight:900;text-align:center}
  .infoNote{margin:12px 12px 0;padding:12px 14px;border-radius:14px;background:rgba(255,255,255,.06);
           border:1px solid var(--tileBorder);color:var(--muted);font-weight:800}

  /* Pay/Transfer page */
  .formCard{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:16px 18px;box-shadow:var(--shadow)}
  .lab{display:block;margin:0 0 8px;color:var(--muted);font-weight:800}
  .dollarWrap{display:flex;align-items:center;gap:8px;border-radius:14px;border:1px solid var(--tileBorder);background:#161616;padding:12px 14px}
  .dollarWrap span{font-size:28px;font-weight:900}
  .dollarWrap input{flex:1;background:transparent;border:0;color:#fff;font-size:28px;font-weight:900;outline:none}
  .selectLine{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--tileBorder);
              background:#161616;color:#fff;border-radius:12px;padding:12px 14px;font-weight:800}
  .selectLine.disabled{opacity:.5;pointer-events:none}
  .menuWrap{position:relative}
  .menu{position:absolute;left:0;right:0;top:calc(100% + 8px);background:#111;border:1px solid var(--tileBorder);
        border-radius:14px;box-shadow:var(--shadow);max-height:0;overflow:hidden;opacity:0;transform:translateY(-6px);
        transition:max-height var(--t),opacity var(--t),transform var(--t);z-index:30}
  .menu.open{max-height:240px;opacity:1;transform:translateY(0)}
  .menu button{width:100%;text-align:left;background:transparent;border:0;color:#fff;padding:12px 14px;font-weight:800}
  .menu button + button{border-top:1px solid var(--tileBorder)}
  .actions{display:flex;gap:10px;margin-top:14px}
  .btn2{flex:1;border-radius:14px;padding:14px 16px;font-weight:900;border:1px solid var(--border);background:#222;color:#fff}
  .btn2.primary{background:var(--green);border-color:transparent}
  .btn2.primary[disabled]{opacity:.5}

  /* Transfer speed (unclickable) */
  .speedRow{display:flex;gap:10px;margin-top:14px}
  .speedBtn{flex:1;border-radius:14px;padding:12px 14px;border:1px solid var(--tileBorder);
            background:#1a1a1a;color:#fff;font-weight:900;text-align:center;pointer-events:none}
  .speedBtn.selected{background:#fff;color:#000}

  /* Loading + confirmation full-screen overlays (keep style consistent) */
  .fscreen{position:fixed;inset:0;display:none;place-items:center;z-index:80;background:rgba(0,0,0,.75)}
  .fscreen.show{display:grid}
  .fsPanel{width:92%;max-width:420px;background:#151515;border:1px solid var(--tileBorder);border-radius:20px;
           box-shadow:var(--shadow);padding:18px}
  .center{display:flex;flex-direction:column;align-items:center;text-align:center}
  .spinner{width:34px;height:34px;border-radius:50%;border:3px solid rgba(255,255,255,.15);border-top-color:#fff;animation:spin 1s linear infinite;margin-bottom:12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .checkCircle{width:64px;height:64px;border-radius:50%;background:#1e7f4b;display:grid;place-items:center;margin:6px 0 10px}
  .checkCircle svg{display:block}
  .confirmTitle{font-size:18px;font-weight:900;margin:6px 0}
  .detailList{margin-top:8px;background:rgba(255,255,255,.06);border:1px solid var(--tileBorder);border-radius:14px;padding:12px}
  .detailRow{display:flex;justify-content:space-between;align-items:center;padding:6px 2px}
  .note{color:var(--muted);margin-top:8px}
  .doneBtn{display:block;width:100%;margin-top:14px;border-radius:14px;padding:14px 16px;font-weight:900;border:1px solid var(--tileBorder);background:#222;color:#fff}

  /* ------- Create Transaction SHEET (modal) ------- */
  .sheet{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:95}
  .sheet.active{pointer-events:auto}
  .sheet .dim{position:absolute;inset:0;background:rgba(0,0,0,.55);opacity:0;transition:opacity var(--t)}
  .sheet.active .dim{opacity:1}
  .sheet .panel{width:92%;max-width:420px;background:#151515;color:#fff;border:1px solid var(--tileBorder);
                border-radius:20px;box-shadow:var(--shadow);
                transform:translateY(18px) scale(.98);opacity:0;
                transition:transform var(--t),opacity var(--t)}
  .sheet.active .panel{transform:translateY(0) scale(1);opacity:1}
  .sheet .head{padding:14px 16px;border-bottom:1px solid var(--tileBorder);font-weight:900;font-size:18px}
  .sheet .body{padding:14px 16px}
  .sheet .field{margin-top:12px}
  .sheet .inp, .sheet .select{width:100%;border-radius:14px;border:1px solid var(--tileBorder);
                              background:#1a1a1a;color:#fff;padding:12px 14px;font-size:16px;outline:none}
  .sheet .actions{display:flex;gap:10px;margin-top:16px}
  .sheet .btn2{background:#222;border-color:var(--tileBorder)}
  .sheet .btn2.primary{background:var(--green)}
</style>
</head>
<body>
<div class="app pos-0" id="app">
  <div class="views">

    <!-- SAVINGS VIEW -->
    <section class="view" id="savings">
      <div class="nav">
        <h1>Savings</h1>
        <div class="iconrow">
          <div class="iconbtn" id="svSearch" aria-label="Search"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path opacity=".9" d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 10-.7.7l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div>
          <div class="iconbtn" id="svAddTxn" aria-label="Create transaction"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path d="M11 11V6h2v5h5v2h-5v5h-2v-5H6v-2z"/></svg></div>
          <div class="iconbtn" aria-label="More"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><circle cx="12" r="2" cy="5"/><circle cx="12" r="2" cy="12"/><circle cx="12" r="2" cy="19"/></svg></div>
        </div>
      </div>

      <div class="content">
        <div class="card accountCard" id="svAcctCard" style="position:relative;cursor:pointer">
          <div style="display:flex;align-items:center;gap:12px">
            <h3 style="margin:0">Current Balance</h3>
            <div class="apyPill">184% APY</div>
          </div>
          <div class="balance" id="svBal">$70.19</div>
        </div>

        <!-- dropdown with account/routing -->
        <div class="acctInfo" id="svAcctInfo">
          <div class="mini"><span>Account</span><span class="big" id="svAcctNum">102979124</span></div>
          <div class="mini"><span>Routing</span><span class="big">072000326</span></div>
        </div>

        <!-- NEW: single Send Money button -->
        <button class="fullBtn" id="svSend">Send Money</button>

        <div class="tile" style="margin-top:14px;cursor:pointer" id="toChecking">
          <div class="tileRow">
            <div class="label">Checking</div>
            <div class="big" id="ckBtnBal">$414.00</div>
          </div>
        </div>

        <div class="sectionTitle">Latest Transactions</div>
        <div id="svListWrap">
          <div class="empty" id="svEmpty">No transactions yet</div>
          <div class="list" id="svList"></div>
        </div>
      </div>
    </section>

    <!-- CHECKING VIEW -->
    <section class="view" id="checking">
      <div class="nav">
        <h1>Checking</h1>
        <div class="iconrow">
          <div class="iconbtn" id="ckSearch" aria-label="Search"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path opacity=".9" d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 10-.7.7l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div>
          <div class="iconbtn" id="ckAddTxn" aria-label="Create transaction"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path d="M11 11V6h2v5h5v2h-5v5h-2v-5H6v-2z"/></svg></div>
          <div class="iconbtn" aria-label="More"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><circle cx="12" r="2" cy="5"/><circle cx="12" r="2" cy="12"/><circle cx="12" r="2" cy="19"/></svg></div>
        </div>
      </div>

      <div class="content">
        <div class="card accountCard" id="ckAcctCard" style="cursor:pointer">
          <div style="display:flex;align-items:center;gap:12px">
            <h3 style="margin:0">Current Balance</h3>
          </div>
          <div class="balance" id="ckBal">$414.00</div>
        </div>

        <!-- Checking account/routing (same routing) -->
        <div class="acctInfo" id="ckAcctInfo">
          <div class="mini"><span>Account</span><span class="big" id="ckAcctNum">501262431</span></div>
          <div class="mini"><span>Routing</span><span class="big">072000326</span></div>
        </div>

        <!-- NEW: single Send Money button -->
        <button class="fullBtn" id="ckSend">Send Money</button>

        <div class="tile" style="margin-top:14px;cursor:pointer" id="toSavings">
          <div class="tileRow">
            <div class="label">Savings</div>
            <div class="big" id="svBtnBal">$70.19</div>
          </div>
        </div>

        <div class="tile" style="margin-top:12px">
          <div class="tileRow">
            <div class="label">Pay over time—</div>
            <div class="big"></div>
          </div>
        </div>

        <div class="sectionTitle">Latest Transactions</div>
        <div id="ckListWrap">
          <div class="empty" id="ckEmpty">No transactions yet</div>
          <div class="list" id="ckList"></div>
        </div>
      </div>
    </section>

    <!-- NEW PAY/TRANSFER PAGE -->
    <section class="view" id="transfer">
      <div class="nav">
        <h1>Pay/Transfer</h1>
        <div class="iconrow"></div>
      </div>
      <div class="content">
        <div class="formCard">
          <label class="lab">Amount</label>
          <div class="dollarWrap">
            <span>$</span>
            <input class="amtInput" id="ptAmount" inputmode="decimal" placeholder="0.00" />
          </div>

          <div style="height:10px"></div>

          <div class="menuWrap">
            <div class="lab">Transfer from</div>
            <button class="selectLine" id="fromLine">
              <span id="fromText">Choose account (from)</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
            <div class="menu" id="fromMenu2">
              <button data-id="savings">SAVINGS (...9124)</button>
              <button data-id="checking">CHECKING (...2431)</button>
              <button data-id="total">TOTAL CHECKING (...6750)</button>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="menuWrap">
            <div class="lab">Transfer to</div>
            <button class="selectLine disabled" id="toLine">
              <span id="toText">Choose account (to)</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
            <div class="menu" id="toMenu2"></div>
          </div>

          <!-- Speed (auto-selected; unclickable) -->
          <div class="speedRow" id="speedRow">
            <div class="speedBtn" id="speedInstant">Instant (~1–2m)</div>
            <div class="speedBtn" id="speedBiz">1–2 business days</div>
          </div>

          <div class="actions">
            <button class="btn2" id="ptCancel">Cancel</button>
            <button class="btn2 primary" id="ptTransfer" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff" style="vertical-align:middle;margin-right:6px"><path d="M12 17a2 2 0 002-2v-1h1a3 3 0 000-6h-1V6a3 3 0 10-6 0v2H7a3 3 0 000 6h1v1a2 2 0 002 2h2zm-2-9V6a2 2 0 114 0v2h-4z"/></svg>
              Transfer
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- TRANSACTION DETAILS (shared) -->
    <section class="view" id="txnView">
      <a class="backPill" id="backTxn">Back</a>
      <div class="txnHeader">
        <div class="txnAmount" id="dAmount">+$0.00</div>
        <div class="txnTitle" id="dTitle">Description</div>
        <div class="txnDate" id="dDate">MM/DD/YY, 0:00 PM</div>
      </div>
      <div class="infoNote" id="pendingBox" style="display:none">Transfer will be posted in 1–2 business days</div>
      <div class="rowD"><div>Account</div><div id="dAccount" style="font-weight:900">Savings</div></div>
      <div class="rowD"><div>Total</div><div id="dTotal" style="font-weight:900">+$0.00</div></div>
      <button class="danger" id="deleteTxn">Delete Transaction</button>
    </section>

  </div>
</div>

<!-- ===== CREATE TRANSACTION SHEET (modal) ===== -->
<div class="sheet ct-panel" id="createSheet" aria-hidden="true">
  <div class="dim"></div>
  <div class="panel" role="dialog" aria-label="Create Transaction">
    <div class="head">Create Transaction</div>
    <div class="body">
      <div class="field">
        <label class="lab">Description</label>
        <input class="inp" id="ctDesc" placeholder="e.g., Interest earned, ATM, etc.">
      </div>
      <div class="field">
        <label class="lab">Amount</label>
        <input class="inp" id="ctAmt" inputmode="decimal" placeholder="0.00" value="0.00" style="font-size:28px;font-weight:900">
      </div>
      <div class="field">
        <label class="lab">Date &amp; time</label>
        <input class="inp" id="ctWhen" type="datetime-local">
      </div>
      <div class="field">
        <label class="lab">Type</label>
        <select class="select" id="ctType">
          <option value="" selected>Choose type</option>
          <option value="credit">Credit (+)</option>
          <option value="debit">Debit (−)</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn2" id="ctCancel">Cancel</button>
        <button class="btn2 primary" id="ctSave" disabled>Save</button>
      </div>
    </div>
  </div>
</div>

<!-- FULLSCREEN Loading -->
<div class="fscreen" id="loadingScreen">
  <div class="fsPanel center">
    <div class="spinner"></div>
    <div style="font-weight:900">Initiating transfer…</div>
  </div>
</div>

<!-- FULLSCREEN Confirmation -->
<div class="fscreen" id="confirmScreen">
  <div class="fsPanel">
    <div class="center">
      <div class="checkCircle">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="#fff"><path d="M9 16.2l-3.5-3.5L4 14.2l5 5 11-11-1.5-1.5z"/></svg>
      </div>
      <div class="confirmTitle" id="confirmTitle">Your transfer has been initiated</div>
    </div>
    <div class="detailList" id="confirmDetails"></div>
    <div class="note" id="confirmNote" style="display:none">Your transfer has been scheduled.</div>
    <button class="doneBtn" id="confirmDone">Done</button>
  </div>
</div>

<script>

// === Cross-app ledger listener (same-origin) ===
const LEDGER_CHANNEL_NAME = 'ledger';
const LEDGER_LOG_KEY = 'global_event_log';
const LEDGER_SEEN_KEY = 'global_event_seen';
const THIS_ACCOUNT_ID = 'checking-123';      // <- match the id you emit

// Optional: if your app already has a helper to add a bank transaction, use it.
// Otherwise here is a tiny fallback that appends to a localStorage array "bank_txns".
function addBankTxnFallback({ id, merchant, amount, iso, status = 'Posted' }) {
  const KEY = 'bank_txns';
  const list = JSON.parse(localStorage.getItem(KEY) || '[]');
  list.push({ id, merchant, amount, iso, status, kind: 'deposit' });
  localStorage.setItem(KEY, JSON.stringify(list));
  // TODO: re-render your UI if needed.
}

// Choose your real renderer if available:
const addBankTxn = (window.addBankTxn || addBankTxnFallback);

function getSeen() {
  try { return new Set(JSON.parse(localStorage.getItem(LEDGER_SEEN_KEY) || '[]')); }
  catch { return new Set(); }
}
function markSeen(id, seenSet) {
  seenSet.add(id);
  localStorage.setItem(LEDGER_SEEN_KEY, JSON.stringify([...seenSet]));
}

function handleLedgerEvent(evt) {
  if (!evt || evt.type !== 'cashback_deposit') return;
  if (evt.toAccountId !== THIS_ACCOUNT_ID) return;

  const seen = getSeen();
  if (seen.has(evt.id)) return;

  addBankTxn({
    id: evt.id,
    merchant: 'Cashback deposited',
    amount: evt.amount,
    iso: evt.iso,
    status: 'Posted'
  });

  markSeen(evt.id, seen);
}

// 1) Live updates via BroadcastChannel
try {
  const ch = new BroadcastChannel(LEDGER_CHANNEL_NAME);
  ch.onmessage = (e) => handleLedgerEvent(e.data);
} catch { /* ignore */ }

// 2) Replay any persisted events on load (so it works even if this tab opens later)
try {
  const log = JSON.parse(localStorage.getItem(LEDGER_LOG_KEY) || '[]');
  log.forEach(handleLedgerEvent);
} catch { /* ignore */ }
  
(()=>{
  const app = document.getElementById('app');

  /* ---------- ACCOUNT METADATA ---------- */
  const SAV_ACCT = { num: '102979124', last4: '9124', name: 'SAVINGS' };
  const CK_ACCT  = { num: '501262431', last4: '2431', name: 'CHECKING' };
  const TOT_ACCT = { num: '000006750', last4: '6750', name: 'TOTAL CHECKING' }; // menu-only

  const money = v=> (Number(v)||0).toLocaleString(undefined,{style:'currency',currency:'USD'});

  /* ---------- SETTINGS VERSION (reset balances by bumping) ---------- */
  const SETTINGS_DEFAULT = {
    version: 3,         // <— bump this to reset default balances below
    savingsBal: 70.19,
    checkingBal: 414.00
  };

  /* ---------- PERSISTED BALANCES ---------- */
  const svState = JSON.parse(localStorage.getItem('sv_state')||'{"bal":70.19}');
  const ckState = JSON.parse(localStorage.getItem('ck_state')||'{"bal":414.00}');
  const storedVer = Number(localStorage.getItem('bank_version')||'0');

  if (storedVer !== SETTINGS_DEFAULT.version) {
    svState.bal = SETTINGS_DEFAULT.savingsBal;
    ckState.bal = SETTINGS_DEFAULT.checkingBal;
    localStorage.setItem('bank_version', String(SETTINGS_DEFAULT.version));
  }

  /* ---------- TRANSACTIONS ---------- */
  // Each txn: { id, desc, amount, iso, type:'credit'|'debit', status:'Posted'|'Pending', note?:string }
  let svTxns = JSON.parse(localStorage.getItem('sv_txns')||'[]');
  let ckTxns = JSON.parse(localStorage.getItem('ck_txns')||'[]');

  function saveAll(){
    localStorage.setItem('sv_state', JSON.stringify(svState));
    localStorage.setItem('ck_state', JSON.stringify(ckState));
    localStorage.setItem('sv_txns', JSON.stringify(svTxns));
    localStorage.setItem('ck_txns', JSON.stringify(ckTxns));
  }

  /* ---------- VIEW NAV ---------- */
  const toChecking = document.getElementById('toChecking');
  const toSavings  = document.getElementById('toSavings');
  toChecking.addEventListener('click', ()=> app.className='app pos-1');
  toSavings.addEventListener('click',  ()=> app.className='app pos-0');

  /* ---------- ACCOUNT CARDS DROP ---- */
  const svCard = document.getElementById('svAcctCard');
  const ckCard = document.getElementById('ckAcctCard');
  const svInfo = document.getElementById('svAcctInfo');
  const ckInfo = document.getElementById('ckAcctInfo');
  svCard.addEventListener('click', ()=> svInfo.classList.toggle('open'));
  ckCard.addEventListener('click', ()=> ckInfo.classList.toggle('open'));

  /* ---------- RENDER BALANCES ---------- */
  const svBalEl = document.getElementById('svBal');
  const ckBalEl = document.getElementById('ckBal');
  const svBtnBal = document.getElementById('svBtnBal');
  const ckBtnBal = document.getElementById('ckBtnBal');
  const svAcctNumEl = document.getElementById('svAcctNum');
  const ckAcctNumEl = document.getElementById('ckAcctNum');
  function renderBalances(){
    svBalEl.textContent = money(svState.bal);
    ckBalEl.textContent = money(ckState.bal);
    svBtnBal.textContent= money(svState.bal);
    ckBtnBal.textContent= money(ckState.bal);
    svAcctNumEl.textContent = SAV_ACCT.num;
    ckAcctNumEl.textContent = CK_ACCT.num;
  }
  renderBalances();

  /* ---------- LIST RENDER ---------- */
  const svList = document.getElementById('svList');
  const ckList = document.getElementById('ckList');
  const svEmpty= document.getElementById('svEmpty');
  const ckEmpty= document.getElementById('ckEmpty');

  function fmtRow(t){
    const sign = t.type==='credit' ? '+' : '-';
    const typeLabel = t.type==='credit'?'Credit':'Debit';
    const statusFrag = t.status==='Pending' ? ' • Pending' : '';
    return `
      <div class="row" data-id="${t.id}">
        <div class="rMain">
          <div class="rTitle">${t.desc} <span style="opacity:.6">• ${typeLabel}${statusFrag}</span></div>
          <div class="rSub">${new Date(t.iso).toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'})}</div>
        </div>
        <div class="rAmt">${sign}${money(Math.abs(t.amount)).replace('$','')}</div>
      </div>`;
  }
  function sortNewest(a,b){ return new Date(b.iso) - new Date(a.iso); }

  function renderTxns(){
    svTxns.sort(sortNewest); ckTxns.sort(sortNewest);
    svList.innerHTML = svTxns.map(fmtRow).join('');
    ckList.innerHTML = ckTxns.map(fmtRow).join('');
    svEmpty.style.display = svTxns.length? 'none':'block';
    ckEmpty.style.display = ckTxns.length? 'none':'block';

    svList.querySelectorAll('.row').forEach(r=>{
      r.addEventListener('click',()=> openTxn('savings', r.dataset.id));
    });
    ckList.querySelectorAll('.row').forEach(r=>{
      r.addEventListener('click',()=> openTxn('checking', r.dataset.id));
    });
  }
  renderTxns();

  /* ---------- TXN DETAILS ---------- */
  const backTxn = document.getElementById('backTxn');
  const dAmount = document.getElementById('dAmount');
  const dTitle  = document.getElementById('dTitle');
  const dDate   = document.getElementById('dDate');
  const dTotal  = document.getElementById('dTotal');
  const dAccount= document.getElementById('dAccount');
  const delBtn  = document.getElementById('deleteTxn');
  const pendingBox = document.getElementById('pendingBox');
  let openCtx = null; // {which:'savings'|'checking', id}

  function openTxn(which,id){
    const arr = which==='savings'? svTxns : ckTxns;
    const t = arr.find(x=>x.id===id); if(!t) return;
    const sign = t.type==='credit'?'+':'-';
    dAmount.textContent = `${sign}${money(Math.abs(t.amount))}`;
    dTitle.textContent  = t.desc;
    dDate.textContent   = new Date(t.iso).toLocaleString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit',hour:'numeric',minute:'2-digit'});
    dTotal.textContent  = `${sign}${money(Math.abs(t.amount))}`;
    dAccount.textContent= which==='savings'?'Savings':'Checking';
    // Pending note
    if (t.status === 'Pending') {
      pendingBox.style.display = 'block';
      pendingBox.textContent = t.note || 'Transfer will be posted in 1–2 business days';
    } else {
      pendingBox.style.display = 'none';
    }
    openCtx = {which,id};
    app.className='app pos-3';
  }
  backTxn.addEventListener('click', ()=>{
    app.className = (openCtx && openCtx.which==='checking') ? 'app pos-1' : 'app pos-0';
  });
  delBtn.addEventListener('click', ()=>{
    if(!openCtx) return;
    let arr = openCtx.which==='savings'? svTxns : ckTxns;
    const i = arr.findIndex(x=>x.id===openCtx.id);
    if(i>-1){ arr.splice(i,1); saveAll(); renderTxns(); }
    backTxn.click();
  });

  /* ---------- CREATE TRANSACTION SHEET ---------- */
  const createSheet = document.getElementById('createSheet');
  const ctDesc = document.getElementById('ctDesc');
  const ctAmt  = document.getElementById('ctAmt');
  const ctWhen = document.getElementById('ctWhen');
  const ctType = document.getElementById('ctType');
  const ctCancel = document.getElementById('ctCancel');
  const ctSave   = document.getElementById('ctSave');
  let createCtx = 'savings'; // current account for new txn

  function openCreate(which){
    createCtx = which;
    ctDesc.value=''; ctAmt.value='0.00';
    ctWhen.value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,16);
    ctType.value='';
    ctSave.disabled = true;
    createSheet.classList.add('active');
  }
  function closeCreate(){ createSheet.classList.remove('active'); }
  document.querySelector('#savings #svAddTxn').addEventListener('click', ()=>openCreate('savings'));
  document.querySelector('#checking #ckAddTxn').addEventListener('click', ()=>openCreate('checking'));
  createSheet.querySelector('.dim').addEventListener('click', closeCreate);
  ctCancel.addEventListener('click', closeCreate);
  ;[ctDesc,ctAmt,ctWhen,ctType].forEach(el=> el.addEventListener('input', ()=>{
    ctSave.disabled = !(ctDesc.value.trim() && Number(ctAmt.value)>0 && ctWhen.value && ctType.value);
  }));
  ctSave.addEventListener('click', ()=>{
    const t = {
      id: 't_'+Math.random().toString(36).slice(2,9),
      desc: ctDesc.value.trim(),
      amount: Number(parseFloat(ctAmt.value).toFixed(2)),
      iso: new Date(ctWhen.value).toISOString(),
      type: ctType.value,
      status: 'Posted'
    };
    if(createCtx==='savings') svTxns.push(t); else ckTxns.push(t);
    saveAll(); renderTxns(); closeCreate();
  });

  /* ---------- PAY/TRANSFER PAGE WIRING ---------- */
  const svSend = document.getElementById('svSend');
  const ckSend = document.getElementById('ckSend');
  let transferOrigin = 'savings'; // where the user came from

  const ptAmount = document.getElementById('ptAmount');
  const fromLine = document.getElementById('fromLine');
  const toLine   = document.getElementById('toLine');
  const fromMenu2= document.getElementById('fromMenu2');
  const toMenu2  = document.getElementById('toMenu2');
  const fromText = document.getElementById('fromText');
  const toText   = document.getElementById('toText');
  const ptCancel = document.getElementById('ptCancel');
  const ptTransfer = document.getElementById('ptTransfer');

  // speed UI
  const speedInstant = document.getElementById('speedInstant');
  const speedBiz     = document.getElementById('speedBiz');
  let speedSel = null; // 'instant' | 'biz'

  let fromSel=null, toSel=null;

  function setSpeed(sel){
    speedSel = sel;
    speedInstant.classList.toggle('selected', sel==='instant');
    speedBiz.classList.toggle('selected', sel==='biz');
  }

  function autoPickSpeed(){
    if(fromSel==='total' || toSel==='total'){ setSpeed('biz'); }
    else if(fromSel && toSel){ setSpeed('instant'); }
    else { setSpeed(null); }
  }

  function resetPayTransfer(origin){
    transferOrigin = origin;
    ptAmount.value='';
    fromSel = null; toSel = null;
    fromText.textContent = 'Choose account (from)';
    toText.textContent   = 'Choose account (to)';
    toLine.classList.add('disabled');
    ptTransfer.disabled = true;
    fromMenu2.classList.remove('open'); toMenu2.classList.remove('open');
    setSpeed(null);
  }

  function validatePT(){
    const amtOk = Number(ptAmount.value) > 0;
    ptTransfer.disabled = !(amtOk && fromSel && toSel);
  }

  function openPT(){ app.className='app pos-2'; }
  svSend.addEventListener('click', ()=>{ resetPayTransfer('savings'); openPT(); });
  ckSend.addEventListener('click', ()=>{ resetPayTransfer('checking'); openPT(); });

  ptCancel.addEventListener('click', ()=>{
    app.className = transferOrigin==='checking' ? 'app pos-1' : 'app pos-0';
  });

  // Menus open/close
  fromLine.addEventListener('click', ()=> fromMenu2.classList.toggle('open'));
  toLine.addEventListener('click', ()=>{
    if(toLine.classList.contains('disabled')) return;
    toMenu2.classList.toggle('open');
  });
  document.addEventListener('click', (e)=>{
    if(!fromLine.contains(e.target) && !fromMenu2.contains(e.target)) fromMenu2.classList.remove('open');
    if(!toLine.contains(e.target) && !toMenu2.contains(e.target)) toMenu2.classList.remove('open');
  });

  // Build a button helper for "to" menu
  function addToBtn(id,label){
    const b=document.createElement('button');
    b.textContent=label; b.dataset.id=id;
    b.addEventListener('click', ()=>{
      toSel=id; toText.textContent=label; toMenu2.classList.remove('open'); autoPickSpeed(); validatePT();
    });
    toMenu2.appendChild(b);
  }

  // Choose "from"
  fromMenu2.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      fromSel = btn.dataset.id; // 'savings' | 'checking' | 'total'
      fromText.textContent = btn.textContent;
      fromMenu2.classList.remove('open');

      // Build "to" menu excluding whichever was chosen for "from"
      toMenu2.innerHTML = '';
      const opts = [
        ['savings','SAVINGS (...'+SAV_ACCT.last4+')'],
        ['checking','CHECKING (...'+CK_ACCT.last4+')'],
        ['total','TOTAL CHECKING (...'+TOT_ACCT.last4+')']
      ].filter(([id])=> id!==fromSel);
      opts.forEach(([id,label])=> addToBtn(id,label));

      toSel=null; toText.textContent='Choose account (to)';
      toLine.classList.remove('disabled');
      autoPickSpeed();
      validatePT();
    });
  });

  ptAmount.addEventListener('input', validatePT);

  /* --------- Loading & Confirmation + POSTING LOGIC ---------- */
  const loadingScreen = document.getElementById('loadingScreen');
  const confirmScreen = document.getElementById('confirmScreen');
  const confirmTitle  = document.getElementById('confirmTitle');
  const confirmDetails= document.getElementById('confirmDetails');
  const confirmNote   = document.getElementById('confirmNote');
  const confirmDone   = document.getElementById('confirmDone');

  function accountLabel(id){
    if(id==='savings')  return `${SAV_ACCT.name} (...${SAV_ACCT.last4})`;
    if(id==='checking') return `${CK_ACCT.name} (...${CK_ACCT.last4})`;
    return `${TOT_ACCT.name} (...${TOT_ACCT.last4})`;
  }
  function labelOnly(id){
    if(id==='savings')  return SAV_ACCT.name;
    if(id==='checking') return CK_ACCT.name;
    return TOT_ACCT.name;
  }
  function last4(id){
    if(id==='savings')  return SAV_ACCT.last4;
    if(id==='checking') return CK_ACCT.last4;
    return TOT_ACCT.last4;
  }

  function postTransfer(amountNum, fromId, toId){
    const nowIso = new Date().toISOString();
    const isBiz = (fromId==='total' || toId==='total');
    const status = isBiz ? 'Pending' : 'Posted';
    const note = isBiz ? 'Transfer will be posted in 1–2 business days' : '';

    // Helper to push a txn
    const mkTxn = (desc, amt, type)=>({
      id: 't_'+Math.random().toString(36).slice(2,9),
      desc, amount: Number(amt.toFixed(2)),
      iso: nowIso, type, status, note
    });

    // Savings <-> Checking (both local): create TWO records + update BOTH balances
    if ((fromId==='savings' || fromId==='checking') && (toId==='savings' || toId==='checking')) {
      // From (debit)
      const descFrom = `Online transfer to ${labelOnly(toId)} ${last4(toId)}`;
      const debitTxn = mkTxn(descFrom, amountNum, 'debit');
      if (fromId==='savings') { svTxns.push(debitTxn); svState.bal = +(svState.bal - amountNum).toFixed(2); }
      else { ckTxns.push(debitTxn); ckState.bal = +(ckState.bal - amountNum).toFixed(2); }

      // To (credit)
      const descTo = `Online transfer from ${labelOnly(fromId)} ${last4(fromId)}`;
      const creditTxn = mkTxn(descTo, amountNum, 'credit');
      if (toId==='savings') { svTxns.push(creditTxn); svState.bal = +(svState.bal + amountNum).toFixed(2); }
      else { ckTxns.push(creditTxn); ckState.bal = +(ckState.bal + amountNum).toFixed(2); }
    } else {
      // One side is TOTAL CHECKING (external). Create ONE local txn + update ONE local balance.
      // Local side is whichever is savings/checking.
      const localId = (fromId==='savings' || fromId==='checking') ? fromId : toId;
      const isFromLocal = localId === fromId;

      const desc = isFromLocal
        ? `Online transfer to ${labelOnly(toId)} ${last4(toId)}`
        : `Online transfer from ${labelOnly(fromId)} ${last4(fromId)}`;

      const type = isFromLocal ? 'debit' : 'credit';
      const txn = mkTxn(desc, amountNum, type);

      if (localId==='savings') {
        svTxns.push(txn);
        svState.bal = +(svState.bal + (type==='credit'? +amountNum : -amountNum)).toFixed(2);
      } else {
        ckTxns.push(txn);
        ckState.bal = +(ckState.bal + (type==='credit'? +amountNum : -amountNum)).toFixed(2);
      }
    }

    saveAll();
    renderBalances();
    renderTxns();
  }

  ptTransfer.addEventListener('click', ()=>{
    loadingScreen.classList.add('show');

    setTimeout(()=>{
      // Post both sides (or one, for TOTAL) BEFORE showing confirm, so lists/balances update immediately
      const amt = Number(parseFloat(ptAmount.value).toFixed(2));
      postTransfer(amt, fromSel, toSel);

      loadingScreen.classList.remove('show');

      const isBiz = (fromSel==='total' || toSel==='total');
      confirmTitle.textContent = 'Your transfer has been initiated';
      confirmDetails.innerHTML = `
        <div class="detailRow"><div>Amount</div><div style="font-weight:900">${money(amt)}</div></div>
        <div class="detailRow"><div>From</div><div style="font-weight:900">${accountLabel(fromSel)}</div></div>
        <div class="detailRow"><div>To</div><div style="font-weight:900">${accountLabel(toSel)}</div></div>
        <div class="detailRow"><div>Speed</div><div style="font-weight:900">${isBiz ? '1–2 business days' : 'Instant (~1–2m)'}</div></div>
      `;
      confirmNote.style.display = isBiz ? 'block' : 'none';
      confirmScreen.classList.add('show');
    }, 5000);
  });

  confirmDone.addEventListener('click', ()=>{
    confirmScreen.classList.remove('show');
    app.className = transferOrigin==='checking' ? 'app pos-1' : 'app pos-0';
  });

})();
</script>
</body>
</html>
