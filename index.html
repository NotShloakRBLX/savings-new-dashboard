<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bank • Savings & Checking</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#141414;
    --panel2:#101010;
    --text:#eaeaea;
    --muted:#a9a9a9;
    --border:rgba(255,255,255,.12);
    --tile:rgba(255,255,255,.05);
    --tileBorder:rgba(255,255,255,.10);
    --blue:#0f2b4d;
    --t:.35s cubic-bezier(.2,.8,.2,1);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:#000;color:var(--text);
    font:15px -apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    font-weight:500;
    -webkit-font-smoothing:auto; text-rendering:optimizeSpeed;
    -webkit-tap-highlight-color: transparent;
  }
  .app{max-width:430px;height:100svh;margin:0 auto;position:relative;overflow:hidden;background:var(--bg)}
  /* 3 views: savings, checking, txn details */
  .views{display:flex;width:300%;height:100%;transition:transform var(--t)}
  .view{width:100%;height:100%;overflow:auto;background:linear-gradient(#0b0b0b,#0a0a0a 60%,#090909)}
  .view::-webkit-scrollbar{width:0;height:0}

  .nav{
    position:sticky;top:0;z-index:5;
    padding:12px 12px 8px;
    background:linear-gradient(180deg,rgba(10,10,10,.96),rgba(10,10,10,.62) 50%,transparent);
    -webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);
  }
  .bankTab{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--blue);border:1px solid rgba(255,255,255,.18);
    color:#fff;padding:10px 12px;border-radius:10px;letter-spacing:.2px;
  }
  .bankTab .dot{width:8px;height:8px;border-radius:50%;background:#6db1ff;opacity:.9}

  /* settings icon at top-right */
  .settingsBtn{
    position:absolute; right:12px; top:12px;
    width:22px; height:22px; opacity:.95;
    cursor:pointer; touch-action: manipulation;
  }
  .settingsBtn img{width:100%;height:100%;display:block}

  .content{padding:12px 12px 28px}

  .balHead{
    display:flex;justify-content:space-between;align-items:flex-end;
    gap:12px;padding:14px;border-radius:12px;background:var(--panel);border:1px solid var(--border)
  }
  .bhCol{min-width:0}
  .label{color:var(--muted);font-size:12px}
  .amt{font-size:30px;line-height:1.05}

  /* hide “Present balance” column on the top cards */
  .presentCol{display:none}

  .apy{display:inline-block;margin-top:10px;padding:6px 10px;border-radius:999px;
       background:var(--tile);border:1px solid var(--tileBorder);font-size:12px}

  .rowBtns{display:flex;gap:10px;margin-top:12px}
  .btn{
    flex:1;padding:14px 16px;border-radius:12px;border:1px solid var(--border);
    background:#efefef;color:#000;font-weight:500;cursor:pointer; touch-action: manipulation;
  }
  .btn.secondary{background:var(--panel2);color:#fff}

  .swapTile{margin-top:12px;padding:12px 14px;border-radius:12px;background:var(--tile);border:1px solid var(--tileBorder);cursor:pointer}
  .swapTop{display:flex;justify-content:space-between;align-items:center}
  .swapName{color:#dcdcdc}
  .swapAcct{color:#a9a9a9;font-size:12px;margin-top:2px}
  .swapAmt{font-size:18px}

  .section{margin-top:16px}
  .sectionTitle{font-size:16px;color:#dcdcdc;margin:0 2px 8px}
  .list{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .row{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
  .row + .row{border-top:1px solid var(--tileBorder)}
  .key{color:var(--muted)}
  .val{color:#fff}

  .moreBtnWrap{display:flex;justify-content:center;padding:12px}
  .moreBtn{
    border-radius:999px;border:1px solid var(--tileBorder);background:transparent;
    color:#dcdcdc;padding:10px 14px;font:inherit;cursor:pointer; touch-action: manipulation;
  }
  .chev{display:inline-block;margin-left:8px;transition:transform var(--t)}
  .open .chev{transform:rotate(180deg)}
  .moreWrap{display:none}
  .list.open .moreWrap{display:block}

  /* slide positions */
  .pos-0 .views{transform:translateX(0%)}        /* Savings */
  .pos-1 .views{transform:translateX(-33.3333%)} /* Checking */
  .pos-2 .views{transform:translateX(-66.6666%)} /* Txn details */

  .btn:active,.swapTile:active{transform:scale(.98);transition:transform var(--t)}

  /* ===== Center popup (Manage account + subpages) ===== */
  .sheet{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:60}
  .sheet .dim{position:absolute;inset:0;background:rgba(0,0,0,.55);opacity:0;transition:opacity var(--t)}
  .sheet .panel{
    width:86%;max-width:360px;background:#151515;border:1px solid var(--tileBorder);
    border-radius:16px;box-shadow:0 18px 50px rgba(0,0,0,.5);
    transform:translateY(8px) scale(.98);opacity:0;transition:transform var(--t),opacity var(--t);overflow:hidden
  }
  .sheet.active{pointer-events:auto}
  .sheet.active .dim{opacity:1}
  .sheet.active .panel{opacity:1;transform:translateY(0) scale(1)}
  .panelHead{padding:14px 16px;border-bottom:1px solid var(--tileBorder);font-weight:700;position:relative}
  .panelBody{padding:14px 16px}
  .mBtn{display:block;width:100%;padding:12px 14px;margin-top:10px;border-radius:12px;border:1px solid var(--border);background:#efefef;color:#000;font-weight:500;cursor:pointer; touch-action: manipulation;}
  .miniBack{
    position:absolute;left:10px;top:8px;
    padding:6px 10px;border-radius:10px;border:1px solid var(--tileBorder);
    background:#1a1a1a;color:#fff;cursor:pointer;font-size:12px; touch-action: manipulation;
  }

  .field{margin-top:10px}
  .lab{display:block;margin:0 0 6px;color:#dcdcdc;font-weight:600;font-size:13px}
  .inp, .sel{
    width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--tileBorder);
    background:#1a1a1a;color:#fff;font:inherit
  }

  .subviews{display:flex;width:300%;transition:transform var(--t);will-change:transform}
  .page{width:100%}

  /* ===== Sapphire-style transactions (no icons) ===== */
  .tile{background:var(--tile);border:1px solid var(--tileBorder);border-radius:8px;padding:14px 16px;position:relative}
  .kb{font-size:13px;color:var(--muted);margin:0 0 6px}
  .txnRow{display:flex;align-items:flex-start;gap:12px;background:transparent;border:0;border-radius:12px;padding:14px 0;cursor:pointer;position:relative}
  .txnRow + .txnRow{margin-top:0}
  .txnMain{flex:1}
  .txnTitle{font-weight:800}
  .txnSub{color:var(--muted);font-size:12px;margin-top:2px}
  .txnAmt{font-weight:600}
  .txnRight{display:flex;align-items:flex-start;gap:8px}
  .chevArrow{opacity:.55;font-size:20px;line-height:1;margin-top:1px}
  .txnStack{border:1px solid rgba(255,255,255,.10);border-radius:6px;overflow:hidden;background:rgba(255,255,255,.035);padding:0 16px}
  .txnStack .txnRow{padding:16px 0}
  .txnStack .txnRow + .txnRow::before{content:"";position:absolute;left:16px;right:16px;top:0;height:1px;background:rgba(255,255,255,.08)}
  .emptyTx{padding:14px 10px;color:var(--muted);font-size:13px}

  /* Txn details page */
  .pill{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:999px;padding:8px 14px}
  .center{padding:20px 16px 8px;text-align:center}
  .txnAmount{font-size:60px;font-weight:900;letter-spacing:-.5px}
  .txnMerchant{color:var(--muted);font-size:22px;font-weight:700;margin-top:6px}
  .txnDate{color:var(--muted);font-size:16px;margin-top:4px}
  .trow{margin:14px 12px;display:flex;justify-content:space-between;align-items:center;
        padding:16px;background:var(--tile);border:1px solid var(--tileBorder);border-radius:8px}
  .trow h3{margin:0;font-size:18px}
  .right{font-weight:900;font-size:18px}
  .statusLine{font-size:18px;margin-bottom:4px}
  .deleteWrap{padding:0 12px 24px}
  .deleteBtn{width:100%;border:0;border-radius:14px;padding:14px 18px;font-weight:900;background:#ff3b30;color:#fff}

</style>
</head>
<body>
<div class="app pos-0" id="app">
  <div class="views">

    <!-- ===== SAVINGS ===== -->
    <section class="view" id="savings">
      <div class="nav">
        <div class="bankTab"><span class="dot"></span>Bank Accounts</div>
        <div class="settingsBtn" data-ctx="savings" aria-label="Settings"><img src="./settings-icon.png" alt="Settings"></div>
      </div>
      <div class="content">

        <div class="balHead" aria-label="Savings balances">
          <div class="bhCol">
            <div class="label">Available balance</div>
            <div class="amt" id="svAvail">$783.11</div>
          </div>
          <div class="bhCol presentCol" style="text-align:right">
            <div class="label">Present balance</div>
            <div class="amt" id="svPresent">$783.11</div>
          </div>
        </div>

        <div class="apy">184% APR</div>

        <div class="rowBtns">
          <button class="btn">Pay</button>
          <button class="btn secondary" id="toTransfer1">Transfer</button>
        </div>

        <div class="swapTile" id="goChecking" aria-label="Open Checking">
          <div class="swapTop">
            <div>
              <div class="swapName">CHECKING (...2431)</div>
              <div class="swapAcct">Acct 375282431</div>
            </div>
            <div class="swapAmt" id="ckMini">$414.00</div>
          </div>
        </div>

        <div class="section">
          <h3 class="sectionTitle">Account details</h3>
          <div class="list" id="svDetails">
            <div class="row"><div class="key">Account number</div><div class="val">551809124</div></div>
            <div class="row"><div class="key">Routing number</div><div class="val">072000326</div></div>

            <div class="moreWrap">
              <div class="row"><div class="key">Available balance</div><div class="val" id="svAvailRow">$783.11</div></div>
              <div class="row"><div class="key">Present balance</div><div class="val" id="svPresentRow">$783.11</div></div>
              <div class="row"><div class="key">Interest rate</div><div class="val">184% APR</div></div>
              <div class="row"><div class="key">Next interest date</div><div class="val">08/31/2025</div></div>
              <div class="row"><div class="key">Next tax statement date</div><div class="val">08/27/2025</div></div>
            </div>

            <div class="moreBtnWrap">
              <button class="moreBtn" id="svMoreBtn" aria-expanded="false">
                Show more <span class="chev">▾</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Latest Transactions (Sapphire-style, no icons) -->
        <div class="section">
          <div class="tile" id="svTxnsTile">
            <div class="kb" style="margin-bottom:8px">Latest Transactions</div>
            <div id="svTxnList"><div class="emptyTx">No transactions yet</div></div>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== CHECKING ===== -->
    <section class="view" id="checking">
      <div class="nav">
        <div class="bankTab"><span class="dot"></span>Bank Accounts</div>
        <div class="settingsBtn" data-ctx="checking" aria-label="Settings"><img src="./settings-icon.png" alt="Settings"></div>
      </div>
      <div class="content">

        <div class="balHead" aria-label="Checking balances">
          <div class="bhCol">
            <div class="label">Available balance</div>
            <div class="amt" id="ckAvail">$414.00</div>
          </div>
          <div class="bhCol presentCol" style="text-align:right">
            <div class="label">Present balance</div>
            <div class="amt" id="ckPresent">$414.00</div>
          </div>
        </div>

        <div class="rowBtns">
          <button class="btn">Pay</button>
          <button class="btn secondary" id="toTransfer2">Transfer</button>
        </div>

        <div class="swapTile" id="goSavings" aria-label="Open Savings">
          <div class="swapTop">
            <div>
              <div class="swapName">SAVINGS (...9124)</div>
              <div class="swapAcct">Acct 551809124</div>
            </div>
            <div class="swapAmt" id="svMini">$783.11</div>
          </div>
        </div>

        <div class="section">
          <h3 class="sectionTitle">Account details</h3>
          <div class="list" id="ckDetails">
            <div class="row"><div class="key">Account number</div><div class="val">375282431</div></div>
            <div class="row"><div class="key">Routing number</div><div class="val">072000326</div></div>

            <div class="moreWrap">
              <div class="row"><div class="key">Available balance</div><div class="val" id="ckAvailRow">$414.00</div></div>
              <div class="row"><div class="key">Present balance</div><div class="val" id="ckPresentRow">$414.00</div></div>
              <div class="row"><div class="key">Interest rate</div><div class="val">0.00%</div></div>
              <div class="row"><div class="key">Interest in 2025</div><div class="val">$0.00</div></div>
            </div>

            <div class="moreBtnWrap">
              <button class="moreBtn" id="ckMoreBtn" aria-expanded="false">
                Show more <span class="chev">▾</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Latest Transactions (Sapphire-style, no icons) -->
        <div class="section">
          <div class="tile" id="ckTxnsTile">
            <div class="kb" style="margin-bottom:8px">Latest Transactions</div>
            <div id="ckTxnList"><div class="emptyTx">No transactions yet</div></div>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== TRANSACTION DETAILS (shared) ===== -->
    <section class="view" id="txnView">
      <div class="nav">
        <button class="pill" id="backTxn">Back</button>
      </div>
      <div class="center">
        <div class="txnAmount" id="dAmount">$0.00</div>
        <div class="txnMerchant" id="dMerchant">Merchant</div>
        <div class="txnDate" id="dDate">MM/DD/YY, 0:00 PM</div>
      </div>
      <div class="tile" style="margin:14px 12px">
        <div class="statusLine" id="dStatus"><strong>Status: Complete</strong></div>
        <div class="kb" id="dCard">SAVINGS (...9124)</div>
      </div>
      <div class="trow"><h3>Total</h3><div class="right" id="dTotal">$0.00</div></div>
      <div class="deleteWrap"><button class="deleteBtn" id="deleteTxnBtn">Delete Transaction</button></div>
    </section>

  </div>
</div>

<!-- Center popup (shared) -->
<div class="sheet" id="settingsSheet" aria-hidden="true">
  <div class="dim"></div>
  <div class="panel" role="dialog" aria-label="Manage account">
    <div class="subviews" id="setViews">
      <!-- Page 0: Home -->
      <div class="page">
        <div class="panelHead">Manage account</div>
        <div class="panelBody">
          <button class="mBtn" id="btnChangeBalance">Change balance</button>
          <button class="mBtn" id="btnAddTxn">Add Transaction</button>
        </div>
      </div>
      <!-- Page 1: Change balance -->
      <div class="page">
        <div class="panelHead">
          <button class="miniBack" id="balBack">Back</button>
          <div style="text-align:center">Change balance</div>
        </div>
        <div class="panelBody">
          <div class="field">
            <label class="lab" for="balAmt">Amount</label>
            <input id="balAmt" class="inp" inputmode="decimal" placeholder="$0.00" />
          </div>
          <button class="mBtn" id="balSave" disabled>Save</button>
        </div>
      </div>
      <!-- Page 2: Add transaction -->
      <div class="page">
        <div class="panelHead">
          <button class="miniBack" id="txnBack">Back</button>
          <div style="text-align:center">Add transaction</div>
        </div>
        <div class="panelBody">
          <div class="field">
            <label class="lab" for="txMerchant">Merchant</label>
            <input id="txMerchant" class="inp" placeholder="e.g., Starbucks" />
          </div>
          <div class="field">
            <label class="lab" for="txAmount">Amount</label>
            <input id="txAmount" class="inp" inputmode="decimal" placeholder="$0.00" />
          </div>
          <div class="field">
            <label class="lab" for="txWhen">Date &amp; time</label>
            <input id="txWhen" class="inp" type="datetime-local" />
          </div>
          <div class="field">
            <label class="lab" for="txStatus">Status</label>
            <select id="txStatus" class="sel">
              <option value="">Choose…</option>
              <option value="Complete">Complete</option>
              <option value="Refunded">Refunded</option>
            </select>
          </div>
          <button class="mBtn" id="txAdd" disabled>Add transaction</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const app = document.getElementById('app');

  const DEFAULTS = { ver: 2, sv: 783.11, ck: 414.00 };
  const ver = Number(localStorage.getItem('acct_ver') || '0');
  if (ver !== DEFAULTS.ver) {
    localStorage.setItem('sv_bal', String(DEFAULTS.sv));
    localStorage.setItem('ck_bal', String(DEFAULTS.ck));
    localStorage.setItem('acct_ver', String(DEFAULTS.ver));
  }
  const money = n => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
  // Accept '.' or ',' as decimal separator
  const parseMoney = s => {
    const cleaned = String(s||'').replace(/,/g,'.').replace(/[^\d.]/g,'');
    const n = parseFloat(cleaned);
    return isFinite(n) ? Math.round(n*100)/100 : NaN;
  };

  let sv = Number(localStorage.getItem('sv_bal') || DEFAULTS.sv);
  let ck = Number(localStorage.getItem('ck_bal') || DEFAULTS.ck);

  const svAvail = document.getElementById('svAvail');
  const svPresent = document.getElementById('svPresent');
  const svMini = document.getElementById('svMini');
  const svAvailRow = document.getElementById('svAvailRow');
  const svPresentRow = document.getElementById('svPresentRow');

  const ckAvail = document.getElementById('ckAvail');
  const ckPresent = document.getElementById('ckPresent');
  const ckMini = document.getElementById('ckMini');
  const ckAvailRow = document.getElementById('ckAvailRow');
  const ckPresentRow = document.getElementById('ckPresentRow');

  function renderBalances(){
    svAvail.textContent = money(sv);
    if (svPresent) svPresent.textContent = money(sv);
    if (svMini) svMini.textContent = money(sv);
    if (svAvailRow) svAvailRow.textContent = money(sv);
    if (svPresentRow) svPresentRow.textContent = money(sv);

    ckAvail.textContent = money(ck);
    if (ckPresent) ckPresent.textContent = money(ck);
    if (ckMini) ckMini.textContent = money(ck);
    if (ckAvailRow) ckAvailRow.textContent = money(ck);
    if (ckPresentRow) ckPresentRow.textContent = money(ck);
  }
  renderBalances();

  // smooth slide nav (between accounts)
  document.getElementById('goChecking').addEventListener('click', () => { app.className = 'app pos-1'; });
  document.getElementById('goSavings').addEventListener('click',  () => { app.className = 'app pos-0'; });

  function setupMore(listId, btnId){
    const list = document.getElementById(listId);
    const btn  = document.getElementById(btnId);
    btn.addEventListener('click', ()=>{
      const open = list.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.innerHTML = open ? 'Hide details <span class="chev">▾</span>' : 'Show more <span class="chev">▾</span>';
    });
  }
  setupMore('svDetails','svMoreBtn');
  setupMore('ckDetails','ckMoreBtn');

  document.getElementById('toTransfer1').addEventListener('click', () => {});
  document.getElementById('toTransfer2').addEventListener('click', () => {});

  // ===== Fast-tap helper =====
  let lastTouchTs = 0;
  function quickTap(el, handler){
    if (!el) return;
    el.addEventListener('touchend', (e)=>{
      lastTouchTs = Date.now();
      e.preventDefault();
      handler(e);
    }, {passive:false});
    el.addEventListener('click', (e)=>{
      if (Date.now() - lastTouchTs < 400) return;
      handler(e);
    });
  }

  // ===== Settings modal wiring =====
  const sheet = document.getElementById('settingsSheet');
  const dim = sheet.querySelector('.dim');
  const setViews = document.getElementById('setViews');
  let settingsCtx = null;

  const NUM_PAGES = 3;
  function gotoPage(i){
    const pct = (i * 100) / NUM_PAGES;
    setViews.style.transform = `translateX(-${pct}%)`;
  }
  function openSettings(ctx){
    settingsCtx = ctx;
    sheet.classList.add('active'); sheet.setAttribute('aria-hidden','false');
    gotoPage(0);
    balAmt.value = '';
    txMerchant.value = '';
    txAmount.value = '';
    txWhen.value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,16);
    txStatus.value = '';
    balSave.disabled = true; txAdd.disabled = true;
  }
  function closeSettings(){ sheet.classList.remove('active'); sheet.setAttribute('aria-hidden','true'); }

  document.querySelectorAll('.settingsBtn').forEach(btn=>{
    quickTap(btn, ()=> openSettings(btn.dataset.ctx));
  });
  quickTap(dim, closeSettings);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSettings(); });

  quickTap(document.getElementById('btnChangeBalance'), ()=> gotoPage(1));
  quickTap(document.getElementById('btnAddTxn'), ()=> gotoPage(2));
  quickTap(document.getElementById('balBack'), ()=> gotoPage(0));
  quickTap(document.getElementById('txnBack'), ()=> gotoPage(0));

  // ===== Change balance (decimal typing) =====
  const balAmt = document.getElementById('balAmt');
  const balSave = document.getElementById('balSave');

  function sanitizeTyping(val){
    let s = String(val || '').replace(/[^\d.,]/g,'');
    const firstSep = s.search(/[.,]/);
    if (firstSep !== -1){
      const head = s.slice(0, firstSep + 1);
      let tail = s.slice(firstSep + 1).replace(/[.,]/g,'');
      tail = tail.slice(0,2);
      s = head + tail;
    }
    return s;
  }

  balAmt.addEventListener('input', ()=>{
    const pos = balAmt.selectionEnd || balAmt.value.length;
    const before = balAmt.value;
    const next = sanitizeTyping(before);
    balAmt.value = next;
    const shift = next.length - before.length;
    const newPos = Math.max(0, pos + shift);
    try{ balAmt.setSelectionRange(newPos, newPos); }catch{}

    const v = parseMoney(balAmt.value);
    balSave.disabled = !(isFinite(v) && v>=0);
  });
  balAmt.addEventListener('blur', ()=>{
    const v = parseMoney(balAmt.value);
    if (isFinite(v)) balAmt.value = v.toLocaleString(undefined,{style:'currency',currency:'USD'});
  });

  quickTap(balSave, ()=>{
    const v = parseMoney(balAmt.value);
    if (!(isFinite(v) && v>=0)) return;
    if (settingsCtx === 'savings'){
      sv = v; localStorage.setItem('sv_bal', String(v));
    } else {
      ck = v; localStorage.setItem('ck_bal', String(v));
    }
    renderBalances();
    closeSettings();
  });

  // ===== Add transaction (settings popup) =====
  const txMerchant = document.getElementById('txMerchant');
  const txAmount   = document.getElementById('txAmount');
  const txWhen     = document.getElementById('txWhen');
  const txStatus   = document.getElementById('txStatus');
  const txAdd      = document.getElementById('txAdd');

  function validateTxn(){
    const ok = txMerchant.value.trim() &&
               isFinite(parseMoney(txAmount.value)) &&
               txWhen.value &&
               (txStatus.value==='Complete' || txStatus.value==='Refunded');
    txAdd.disabled = !ok;
  }
  txAmount.addEventListener('input', validateTxn);
  [txMerchant, txWhen, txStatus].forEach(el=> el.addEventListener('input', validateTxn));

  function adjustBalance(which, amt, status){
    const delta = (status === 'Refunded') ? +amt : -amt; // refund adds back, complete subtracts
    if (which === 'savings'){
      sv = Math.round((sv + delta)*100)/100;
      localStorage.setItem('sv_bal', String(sv));
    } else {
      ck = Math.round((ck + delta)*100)/100;
      localStorage.setItem('ck_bal', String(ck));
    }
    renderBalances();
  }

  quickTap(txAdd, ()=>{
    const amt = parseMoney(txAmount.value);
    if (txAdd.disabled || !isFinite(amt)) return;
    const which = settingsCtx === 'savings' ? 'savings' : 'checking';
    const key = which === 'savings' ? 'sv_txns' : 'ck_txns';
    const list = JSON.parse(localStorage.getItem(key) || '[]');
    list.push({
      id:'t_'+Math.random().toString(36).slice(2,9),
      merchant: txMerchant.value.trim(),
      amount: amt,
      iso: new Date(txWhen.value).toISOString(),
      status: txStatus.value
    });
    localStorage.setItem(key, JSON.stringify(list));
    // auto-update balances based on the new transaction
    adjustBalance(which, amt, txStatus.value);
    closeSettings();
    // refresh lists so new txn appears
    svTxns = loadTxns('sv_txns');
    ckTxns = loadTxns('ck_txns');
    renderTxnLists();
  });

  // ===== Transactions (lists + details) =====
  const SV_LAST4 = '9124';
  const CK_LAST4 = '2431';

  // Remove all "undefined" / blank-merchant txns on load (both accounts)
  function cleanTxns(key){
    try{
      const raw = localStorage.getItem(key);
      const arr = raw ? JSON.parse(raw) : [];
      const filtered = (Array.isArray(arr) ? arr : []).filter(t=>{
        const m = (t && typeof t.merchant !== 'undefined') ? String(t.merchant).trim() : '';
        return m && m.toLowerCase() !== 'undefined' && m.toLowerCase() !== 'null';
      });
      if (filtered.length !== (Array.isArray(arr)?arr.length:0)){
        localStorage.setItem(key, JSON.stringify(filtered));
      }
      return filtered;
    }catch(e){ return []; }
  }

  function loadTxns(key){ return cleanTxns(key); }
  let svTxns = loadTxns('sv_txns');
  let ckTxns = loadTxns('ck_txns');

  const svTxnListEl = document.getElementById('svTxnList');
  const ckTxnListEl = document.getElementById('ckTxnList');

  function shortDate(iso){const d=new Date(iso);return d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'})}
  function fullDateTime(iso){const d=new Date(iso);return d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'})+', '+d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'})}

  function renderList(targetEl, arr, which){
    if (!arr.length){
      targetEl.innerHTML = '<div class="emptyTx">No transactions yet</div>';
      return;
    }
    const rows = arr
      .slice()
      .sort((a,b)=> new Date(b.iso) - new Date(a.iso))
      .map(t=>`
        <div class="txnRow" data-id="${t.id}" data-which="${which}">
          <div class="txnMain">
            <div class="txnTitle">${t.merchant}${t.status?` <span style="opacity:.6">• ${t.status}</span>`:''}</div>
            <div class="txnSub">${shortDate(t.iso)}</div>
          </div>
          <div class="txnRight">
            <div class="txnAmt">${money(Number(t.amount)||0)}</div>
            <div class="chevArrow">›</div>
          </div>
        </div>
      `).join('');
    targetEl.innerHTML = `<div class="txnStack">${rows}</div>`;
    targetEl.querySelectorAll('.txnRow').forEach(r=>{
      r.addEventListener('click',()=> openTxn(r.dataset.which, r.dataset.id));
    });
  }

  function renderTxnLists(){
    renderList(svTxnListEl, svTxns, 'savings');
    renderList(ckTxnListEl, ckTxns, 'checking');
  }
  renderTxnLists();

  // Details view
  const dAmount   = document.getElementById('dAmount');
  const dMerchant = document.getElementById('dMerchant');
  const dDate     = document.getElementById('dDate');
  const dStatus   = document.getElementById('dStatus');
  const dCard     = document.getElementById('dCard');
  const dTotal    = document.getElementById('dTotal');
  const backTxn   = document.getElementById('backTxn');
  const delBtn    = document.getElementById('deleteTxnBtn');
  let openCtx = null; // { which:'savings'|'checking', id:string }

  function openTxn(which,id){
    const list = which==='savings' ? svTxns : ckTxns;
    const t = list.find(x=>x.id===id);
    if(!t) return;
    dAmount.textContent   = money(Number(t.amount)||0);
    dMerchant.textContent = t.merchant || '';
    dDate.textContent     = fullDateTime(t.iso);
    dStatus.innerHTML     = `<strong>Status: ${t.status || 'Complete'}</strong>`;
    dCard.textContent     = which==='savings' ? `SAVINGS (...${SV_LAST4})` : `CHECKING (...${CK_LAST4})`;
    dTotal.textContent    = money(Number(t.amount)||0);
    openCtx = {which,id};
    app.className = 'app pos-2';
  }

  backTxn.addEventListener('click', ()=>{
    if(!openCtx) { app.className='app pos-0'; return; }
    app.className = (openCtx.which==='checking') ? 'app pos-1' : 'app pos-0';
  });

  delBtn.addEventListener('click', ()=>{
    if(!openCtx) return;
    if(openCtx.which==='savings'){
      const i = svTxns.findIndex(x=>x.id===openCtx.id);
      if(i>-1){ svTxns.splice(i,1); localStorage.setItem('sv_txns', JSON.stringify(svTxns)); }
    }else{
      const i = ckTxns.findIndex(x=>x.id===openCtx.id);
      if(i>-1){ ckTxns.splice(i,1); localStorage.setItem('ck_txns', JSON.stringify(ckTxns)); }
    }
    renderTxnLists();
    backTxn.click();
  });

})();
</script>
</body>
</html>
