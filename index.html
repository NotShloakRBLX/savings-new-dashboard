<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bank • Savings & Checking</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#141414;
    --panel2:#101010;
    --text:#eaeaea;
    --muted:#a9a9a9;
    --border:rgba(255,255,255,.12);
    --tile:rgba(255,255,255,.05);
    --tileBorder:rgba(255,255,255,.10);
    --blue:#0f2b4d;
    --t:.30s cubic-bezier(.2,.8,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:#000;color:var(--text);
    font:15px -apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    font-weight:500;-webkit-font-smoothing:auto;text-rendering:optimizeSpeed;
    -webkit-tap-highlight-color:transparent;
  }
  .app{max-width:430px;height:100svh;margin:0 auto;position:relative;overflow:hidden;background:var(--bg)}
  .views{display:flex;width:300%;height:100%;transition:transform var(--t)}
  .view{width:100%;height:100%;overflow:auto;background:linear-gradient(#0b0b0b,#0a0a0a 60%,#090909)}
  .view::-webkit-scrollbar{width:0;height:0}

  .nav{
    position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;
    padding:12px 12px 8px;
    background:linear-gradient(180deg,rgba(10,10,10,.96),rgba(10,10,10,.62) 50%,transparent);
    -webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);
  }
  .bankTab{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--blue);border:1px solid rgba(255,255,255,.18);
    color:#fff;padding:10px 12px;border-radius:10px;letter-spacing:.2px;
  }
  .bankTab .dot{width:8px;height:8px;border-radius:50%;background:#6db1ff;opacity:.9}

  /* icon buttons like Sapphire */
  .iconrow{display:flex;gap:8px}
  .iconbtn{
    width:34px;height:34px;border-radius:999px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);display:grid;place-items:center;cursor:pointer;transition:transform var(--t)
  }
  .iconbtn:active{transform:scale(.96)}

  .content{padding:12px 12px 28px}

  .balHead{
    display:flex;justify-content:space-between;align-items:flex-end;
    gap:12px;padding:14px;border-radius:12px;background:var(--panel);border:1px solid var(--border)
  }
  .bhCol{min-width:0}
  .label{color:var(--muted);font-size:12px}
  .amt{font-size:30px;line-height:1.05}
  .presentCol{display:none} /* upper card only shows Available */

  .apy{display:inline-block;margin-top:10px;padding:6px 10px;border-radius:999px;background:var(--tile);border:1px solid var(--tileBorder);font-size:12px}

  .rowBtns{display:flex;gap:10px;margin-top:12px}
  .btn{flex:1;padding:14px 16px;border-radius:12px;border:1px solid var(--border);background:#efefef;color:#000;font-weight:500;cursor:pointer}
  .btn.secondary{background:var(--panel2);color:#fff}

  .swapTile{margin-top:12px;padding:12px 14px;border-radius:12px;background:var(--tile);border:1px solid var(--tileBorder);cursor:pointer}
  .swapTop{display:flex;justify-content:space-between;align-items:center}
  .swapName{color:#dcdcdc}
  .swapAcct{color:#a9a9a9;font-size:12px;margin-top:2px}
  .swapAmt{font-size:18px}

  .section{margin-top:16px}
  .sectionTitle{font-size:16px;color:#dcdcdc;margin:0 2px 8px}
  .list{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .row{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
  .row + .row{border-top:1px solid var(--tileBorder)}
  .key{color:var(--muted)}
  .val{color:#fff}
  .moreBtnWrap{display:flex;justify-content:center;padding:12px}
  .moreBtn{border-radius:999px;border:1px solid var(--tileBorder);background:transparent;color:#dcdcdc;padding:10px 14px;font:inherit;cursor:pointer}
  .chev{display:inline-block;margin-left:8px;transition:transform var(--t)}
  .open .chev{transform:rotate(180deg)}
  .moreWrap{display:none}
  .list.open .moreWrap{display:block}

  /* transactions (card look, no icons) */
  .tile{background:var(--tile);border:1px solid var(--tileBorder);border-radius:8px;padding:14px 16px;position:relative}
  .kb{font-size:13px;color:var(--muted);margin:0 0 6px}
  .txnRow{display:flex;gap:12px;align-items:flex-start;background:transparent;border:0;border-radius:12px;padding:16px 0;cursor:pointer;position:relative}
  .txnRow + .txnRow::before{content:"";position:absolute;left:0;right:0;top:0;height:1px;background:rgba(255,255,255,.08)}
  .txnMain{flex:1}
  .txnTitle{font-weight:800}
  .txnSub{color:var(--muted);font-size:12px;margin-top:2px}
  .txnRight{display:flex;align-items:flex-start;gap:8px}
  .txnAmt{font-weight:700}
  .chevArrow{opacity:.55;font-size:20px;line-height:1;margin-top:1px}
  .txnStack{border:1px solid rgba(255,255,255,.10);border-radius:6px;background:rgba(255,255,255,.035);padding:0 0}
  .txnStack .txnRow{padding:16px 16px}
  .emptyTx{padding:10px 14px;color:var(--muted);font-size:13px}

  .center{padding:20px 16px 8px;text-align:center}
  .pill{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:999px;padding:8px 14px}
  .txnAmount{font-size:60px;font-weight:900;letter-spacing:-.5px}
  .txnMerchant{color:var(--muted);font-size:22px;font-weight:700;margin-top:6px}
  .txnDate{color:var(--muted);font-size:16px;margin-top:4px}
  .trow{margin:14px 12px;display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--tile);border:1px solid var(--tileBorder);border-radius:8px}
  .trow h3{margin:0;font-size:18px}
  .right{font-weight:900;font-size:18px}
  .statusLine{font-size:18px;margin-bottom:4px}
  .deleteWrap{padding:0 12px 24px}
  .deleteBtn{width:100%;border:0;border-radius:14px;padding:14px 18px;font-weight:900;background:#ff3b30;color:#fff}

  .pos-0 .views{transform:translateX(0%)}          /* Savings */
  .pos-1 .views{transform:translateX(-33.3333%)}   /* Checking */
  .pos-2 .views{transform:translateX(-66.6666%)}   /* Txn details */

  /* Bottom sheets (dark) */
  .sheet{position:fixed;inset:0;display:grid;place-items:end center;pointer-events:none;z-index:60}
  .sheet.active{pointer-events:auto}
  .dim{position:absolute;inset:0;background:rgba(0,0,0,.45);opacity:0;transition:opacity var(--t)}
  .sheet.active .dim{opacity:1}
  .panel{width:100%;max-width:430px;background:#111;color:#fff;border-radius:20px 20px 0 0;transform:translateY(100%);transition:transform var(--t)}
  .sheet.active .panel{transform:translateY(0)}
  .panel.settled{transform:none !important}
  .sheet.noanim .panel, .sheet.noanim .dim{transition:none !important}

  .panelHead{display:flex;align-items:center;justify-content:center;padding:12px 14px 0;position:relative}
  .closeX{position:absolute;left:14px;top:8px;width:36px;height:36px;border-radius:10px;border:none;background:#1f1f1f;color:#fff;font-size:20px;font-weight:900;cursor:pointer}
  .title{font-size:24px;font-weight:900;margin:6px 0 0;text-align:center}
  .form{padding:8px 14px 18px}
  .form label{display:block;font-weight:800;margin:12px 0 6px}
  .form input,.form select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;font:inherit}
  .actions{display:flex;justify-content:center;gap:10px;padding:0 14px 18px}
  .btn.darkPrimary{background:#000;color:#fff;border:0;border-radius:14px;padding:14px 22px;font-weight:900;min-width:65%}
  .btn.gray{background:#efefef;color:#000;border:0;border-radius:14px;padding:14px 22px;font-weight:900}
  .other{text-align:center;padding-bottom:16px;color:#007aff;font-weight:900}
</style>
</head>
<body>
<div class="app pos-0" id="app">
  <div class="views">

    <!-- ===== SAVINGS ===== -->
    <section class="view" id="savings">
      <div class="nav">
        <div class="bankTab"><span class="dot"></span>Bank Accounts</div>
        <div class="iconrow">
          <!-- Add Transaction (plus) -->
          <div class="iconbtn" id="svAdd" aria-label="Add Transaction">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
          </div>
          <!-- Change Balance ($) -->
          <div class="iconbtn" id="svBal" aria-label="Change Balance">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path d="M12 3a1 1 0 011 1v1.06a4.5 4.5 0 013.5 4.39c0 1.98-1.2 3.33-3.53 3.98l-.97.28c-1.72.49-2.5 1.1-2.5 2.17 0 1.17 1.03 2.02 2.5 2.02 1.56 0 2.58-.77 2.86-2h2.04c-.3 2.24-1.98 3.67-4.36 3.94V20a1 1 0 01-2 0v-1.07c-2.4-.3-4.04-1.84-4.04-3.99 0-2.02 1.34-3.21 3.92-3.94l1.1-.31c1.53-.43 2.02-.9 2.02-1.9 0-1.02-.95-1.82-2.37-1.82-1.43 0-2.38.72-2.6 2H6.04c.24-2.13 1.86-3.55 4-3.86V4a1 1 0 011-1z"/></svg>
          </div>
        </div>
      </div>
      <div class="content">
        <div class="balHead" aria-label="Savings balances">
          <div class="bhCol">
            <div class="label">Available balance</div>
            <div class="amt" id="svAvail">$783.11</div>
          </div>
          <div class="bhCol presentCol" style="text-align:right">
            <div class="label">Present balance</div>
            <div class="amt" id="svPresent">$783.11</div>
          </div>
        </div>

        <div class="apy">184% APR</div>

        <div class="rowBtns">
          <button class="btn">Pay</button>
          <button class="btn secondary" id="toTransfer1">Transfer</button>
        </div>

        <div class="swapTile" id="goChecking" aria-label="Open Checking">
          <div class="swapTop">
            <div>
              <div class="swapName">CHECKING (...2431)</div>
              <div class="swapAcct">Acct 375282431</div>
            </div>
            <div class="swapAmt" id="ckMini">$414.00</div>
          </div>
        </div>

        <div class="section">
          <h3 class="sectionTitle">Account details</h3>
          <div class="list" id="svDetails">
            <div class="row"><div class="key">Account number</div><div class="val">551809124</div></div>
            <div class="row"><div class="key">Routing number</div><div class="val">072000326</div></div>
            <div class="moreWrap">
              <div class="row"><div class="key">Available balance</div><div class="val" id="svAvailRow">$783.11</div></div>
              <div class="row"><div class="key">Present balance</div><div class="val" id="svPresentRow">$783.11</div></div>
              <div class="row"><div class="key">Interest rate</div><div class="val">184% APR</div></div>
              <div class="row"><div class="key">Next interest date</div><div class="val">08/31/2025</div></div>
              <div class="row"><div class="key">Next tax statement date</div><div class="val">08/27/2025</div></div>
            </div>
            <div class="moreBtnWrap">
              <button class="moreBtn" id="svMoreBtn" aria-expanded="false">Show more <span class="chev">▾</span></button>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="tile" id="svTxTile">
            <div class="kb" style="margin-bottom:8px">Latest Savings Transactions</div>
            <div id="svTxnList" class="txnStack"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== CHECKING ===== -->
    <section class="view" id="checking">
      <div class="nav">
        <div class="bankTab"><span class="dot"></span>Bank Accounts</div>
        <div class="iconrow">
          <div class="iconbtn" id="ckAdd" aria-label="Add Transaction">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
          </div>
          <div class="iconbtn" id="ckBal" aria-label="Change Balance">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path d="M12 3a1 1 0 011 1v1.06a4.5 4.5 0 013.5 4.39c0 1.98-1.2 3.33-3.53 3.98l-.97.28c-1.72.49-2.5 1.1-2.5 2.17 0 1.17 1.03 2.02 2.5 2.02 1.56 0 2.58-.77 2.86-2h2.04c-.3 2.24-1.98 3.67-4.36 3.94V20a1 1 0 01-2 0v-1.07c-2.4-.3-4.04-1.84-4.04-3.99 0-2.02 1.34-3.21 3.92-3.94l1.1-.31c1.53-.43 2.02-.9 2.02-1.9 0-1.02-.95-1.82-2.37-1.82-1.43 0-2.38.72-2.6 2H6.04c.24-2.13 1.86-3.55 4-3.86V4a1 1 0 011-1z"/></svg>
          </div>
        </div>
      </div>
      <div class="content">
        <div class="balHead" aria-label="Checking balances">
          <div class="bhCol">
            <div class="label">Available balance</div>
            <div class="amt" id="ckAvail">$414.00</div>
          </div>
          <div class="bhCol presentCol" style="text-align:right">
            <div class="label">Present balance</div>
            <div class="amt" id="ckPresent">$414.00</div>
          </div>
        </div>

        <div class="rowBtns">
          <button class="btn">Pay</button>
          <button class="btn secondary" id="toTransfer2">Transfer</button>
        </div>

        <div class="swapTile" id="goSavings" aria-label="Open Savings">
          <div class="swapTop">
            <div>
              <div class="swapName">SAVINGS (...9124)</div>
              <div class="swapAcct">Acct 551809124</div>
            </div>
            <div class="swapAmt" id="svMini">$783.11</div>
          </div>
        </div>

        <div class="section">
          <h3 class="sectionTitle">Account details</h3>
          <div class="list" id="ckDetails">
            <div class="row"><div class="key">Account number</div><div class="val">375282431</div></div>
            <div class="row"><div class="key">Routing number</div><div class="val">072000326</div></div>
            <div class="moreWrap">
              <div class="row"><div class="key">Available balance</div><div class="val" id="ckAvailRow">$414.00</div></div>
              <div class="row"><div class="key">Present balance</div><div class="val" id="ckPresentRow">$414.00</div></div>
              <div class="row"><div class="key">Interest rate</div><div class="val">0.00%</div></div>
              <div class="row"><div class="key">Interest in 2025</div><div class="val">$0.00</div></div>
            </div>
            <div class="moreBtnWrap">
              <button class="moreBtn" id="ckMoreBtn" aria-expanded="false">Show more <span class="chev">▾</span></button>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="tile" id="ckTxTile">
            <div class="kb" style="margin-bottom:8px">Latest Checking Transactions</div>
            <div id="ckTxnList" class="txnStack"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== TXN DETAILS ===== -->
    <section class="view" id="txnView">
      <div class="nav">
        <button class="pill" id="backTxn">Back</button>
        <div style="width:34px"></div>
      </div>
      <div class="center">
        <div class="txnAmount" id="dAmount">$0.00</div>
        <div class="txnMerchant" id="dMerchant">Merchant</div>
        <div class="txnDate" id="dDate">MM/DD/YY, 0:00 PM</div>
      </div>
      <div class="tile" style="margin:14px 12px">
        <div class="statusLine" id="dStatus"><strong>Status: Complete</strong></div>
        <div class="kb" id="dAcctLabel">Checking (…2431)</div>
      </div>
      <div class="trow"><h3>Total</h3><div class="right" id="dTotal">$0.00</div></div>
      <div class="deleteWrap"><button class="deleteBtn" id="deleteTxnBtn">Delete Transaction</button></div>
    </section>

  </div>
</div>

<!-- Add Transaction -->
<div class="sheet" id="addTxnSheet" aria-hidden="true">
  <div class="dim" id="addDim"></div>
  <div class="panel">
    <div class="panelHead"><button class="closeX" id="addClose">×</button></div>
    <div class="title">Add Transaction</div>
    <div class="form">
      <label for="txMerchant">Merchant</label>
      <input id="txMerchant" type="text" placeholder="e.g., Starbucks" />
      <label for="txAmount">Amount</label>
      <input id="txAmount" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
      <label for="txWhen">Date &amp; Time</label>
      <input id="txWhen" type="datetime-local" />
      <label for="txType">Type</label>
      <select id="txType">
        <option value="debit">Debit (−)</option>
        <option value="credit">Credit (+)</option>
      </select>
      <label for="txStatus">Status</label>
      <select id="txStatus">
        <option value="Complete">Complete</option>
        <option value="Refunded">Refunded</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn darkPrimary" id="txContinue">Continue</button>
    </div>
    <div class="other" id="txCancel">Cancel</div>
  </div>
</div>

<!-- Confirm -->
<div class="sheet" id="confirmSheet" aria-hidden="true">
  <div class="dim" id="cfDim"></div>
  <div class="panel">
    <div class="panelHead"><button class="closeX" id="cfClose">×</button></div>
    <div class="title">Confirm Transaction</div>
    <div class="form" id="cfSummary"></div>
    <div class="actions">
      <button class="btn darkPrimary" id="cfAdd">Add Transaction</button>
      <button class="btn gray" id="cfBack">Go Back &amp; Edit</button>
    </div>
  </div>
</div>

<!-- Change Balance -->
<div class="sheet" id="balSheet" aria-hidden="true">
  <div class="dim" id="balDim"></div>
  <div class="panel">
    <div class="panelHead"><button class="closeX" id="balClose">×</button></div>
    <div class="title">Change balance</div>
    <div class="form">
      <label for="editBalance">New balance</label>
      <input id="editBalance" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
    </div>
    <div class="actions">
      <button class="btn darkPrimary" id="balSave">Save</button>
      <button class="btn gray" id="balCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
(() => {
  const app = document.getElementById('app');

  /* ===== general helpers ===== */
  const money = n => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
  const signMoney = (amt, type) => (type==='credit' ? '+ ' : '− ') + money(Math.abs(amt));
  const nowLocalISO = () => new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,16);

  /* ===== sheet utilities (instant + guarded) ===== */
  function stopInsideClicks(sheet){
    const panel = sheet.querySelector('.panel');
    ['click','mousedown','mouseup','pointerdown','pointerup','touchstart','touchend']
      .forEach(ev => panel.addEventListener(ev, e => e.stopPropagation(), {passive:false}));
  }
  function openSheet(sheet,{instant=false}={}){
    stopInsideClicks(sheet);
    const panel = sheet.querySelector('.panel');
    if(instant){
      sheet.classList.add('noanim'); sheet.classList.add('active');
      requestAnimationFrame(()=>{ panel.classList.add('settled'); sheet.classList.remove('noanim'); });
    }else{
      sheet.classList.add('active');
      panel.addEventListener('transitionend', function onEnd(e){
        if(e.propertyName!=='transform') return;
        panel.removeEventListener('transitionend', onEnd);
        panel.classList.add('settled');
      });
    }
  }
  function closeSheet(sheet){
    const panel = sheet.querySelector('.panel');
    panel.classList.remove('settled');
    sheet.classList.remove('active');
  }

  /* ===== balances init ===== */
  const DEFAULTS = { ver: 5, sv: 783.11, ck: 414.00 };
  const ver = Number(localStorage.getItem('acct_ver') || '0');
  if (ver !== DEFAULTS.ver) {
    localStorage.setItem('sv_bal', String(DEFAULTS.sv));
    localStorage.setItem('ck_bal', String(DEFAULTS.ck));
    localStorage.setItem('acct_ver', String(DEFAULTS.ver));
    localStorage.setItem('sv_txns','[]');
    localStorage.setItem('ck_txns','[]');
  }

  let sv = Number(localStorage.getItem('sv_bal') || DEFAULTS.sv);
  let ck = Number(localStorage.getItem('ck_bal') || DEFAULTS.ck);

  const svAvail = document.getElementById('svAvail');
  const svPresent = document.getElementById('svPresent');
  const svMini = document.getElementById('svMini');
  const svAvailRow = document.getElementById('svAvailRow');
  const svPresentRow = document.getElementById('svPresentRow');

  const ckAvail = document.getElementById('ckAvail');
  const ckPresent = document.getElementById('ckPresent');
  const ckMini = document.getElementById('ckMini');
  const ckAvailRow = document.getElementById('ckAvailRow');
  const ckPresentRow = document.getElementById('ckPresentRow');

  function renderBalances(){
    svAvail.textContent = money(sv);
    if (svPresent) svPresent.textContent = money(sv);
    if (svMini) svMini.textContent = money(sv);
    if (svAvailRow) svAvailRow.textContent = money(sv);
    if (svPresentRow) svPresentRow.textContent = money(sv);

    ckAvail.textContent = money(ck);
    if (ckPresent) ckPresent.textContent = money(ck);
    if (ckMini) ckMini.textContent = money(ck);
    if (ckAvailRow) ckAvailRow.textContent = money(ck);
    if (ckPresentRow) ckPresentRow.textContent = money(ck);
  }
  renderBalances();

  /* ===== nav ===== */
  document.getElementById('goChecking').addEventListener('click', () => app.className = 'app pos-1');
  document.getElementById('goSavings').addEventListener('click',  () => app.className = 'app pos-0');

  /* ===== show more toggles ===== */
  function setupMore(listId, btnId){
    const list = document.getElementById(listId);
    const btn  = document.getElementById(btnId);
    btn.addEventListener('click', ()=>{
      const open = list.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.innerHTML = open ? 'Hide details <span class="chev">▾</span>' : 'Show more <span class="chev">▾</span>';
    });
  }
  setupMore('svDetails','svMoreBtn');
  setupMore('ckDetails','ckMoreBtn');

  /* ===== transactions ===== */
  const loadTxns = key => { try{const t=JSON.parse(localStorage.getItem(key)||'[]');return Array.isArray(t)?t:[]}catch(e){return []} };
  const saveTxns = (key, arr) => localStorage.setItem(key, JSON.stringify(arr));

  let svTx = loadTxns('sv_txns');
  let ckTx = loadTxns('ck_txns');

  const fmtShortDate = iso => {
    const d=new Date(iso); return d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'});
  };

  function renderTxnList(which){
    const listEl = which==='savings' ? document.getElementById('svTxnList') : document.getElementById('ckTxnList');
    const txns = (which==='savings'? svTx : ckTx)
                  .filter(t=>t && typeof t.merchant==='string' && isFinite(+t.amount))
                  .slice().sort((a,b)=>new Date(b.iso)-new Date(a.iso));
    if (!txns.length){ listEl.innerHTML = '<div class="emptyTx">No transactions yet</div>'; return; }
    listEl.innerHTML = txns.map(t=>`
      <div class="txnRow" data-id="${t.id}" data-ctx="${which}">
        <div class="txnMain">
          <div class="txnTitle">${t.merchant}${t.status?` <span style="opacity:.6">• ${t.status}</span>`:''}</div>
          <div class="txnSub">${fmtShortDate(t.iso)}</div>
        </div>
        <div class="txnRight">
          <div class="txnAmt">${signMoney(t.amount, t.type)}</div>
          <div class="chevArrow">›</div>
        </div>
      </div>
    `).join('');
    listEl.querySelectorAll('.txnRow').forEach(row=>{
      row.addEventListener('click',()=>openTxn(row.dataset.ctx,row.dataset.id));
    });
  }
  function renderAllTx(){ renderTxnList('savings'); renderTxnList('checking'); }
  renderAllTx();

  /* ===== details ===== */
  let currentCtx='savings', currentTxnId=null;
  function openTxn(ctx,id){
    currentCtx=ctx; currentTxnId=id;
    const t = (ctx==='savings'?svTx:ckTx).find(x=>x.id===id); if(!t) return;
    const last4 = ctx==='savings' ? '9124' : '2431';
    document.getElementById('dAmount').textContent = signMoney(t.amount, t.type);
    document.getElementById('dMerchant').textContent = t.merchant || '';
    const d = new Date(t.iso);
    document.getElementById('dDate').textContent = d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'}) + ', ' + d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
    document.getElementById('dStatus').innerHTML = `<strong>Status: ${t.status||'Complete'}</strong>`;
    document.getElementById('dAcctLabel').textContent = (ctx==='savings'?'Savings':'Checking') + ' (...' + last4 + ')';
    document.getElementById('dTotal').textContent = signMoney(t.amount, t.type);
    app.className='app pos-2';
  }
  document.getElementById('backTxn').addEventListener('click',   () => app.className = (currentCtx==='savings'?'app pos-0':'app pos-1'));

  document.getElementById('deleteTxnBtn').addEventListener('click', ()=>{
    const arr = currentCtx==='savings'?svTx:ckTx;
    const i = arr.findIndex(t=>t.id===currentTxnId);
    if(i>-1){
      const t = arr[i];
      if(currentCtx==='savings'){
        sv += (t.type==='credit' ? -t.amount : +t.amount); // reverse effect
        localStorage.setItem('sv_bal', String(sv));
      }else{
        ck += (t.type==='credit' ? -t.amount : +t.amount);
        localStorage.setItem('ck_bal', String(ck));
      }
      arr.splice(i,1);
      saveTxns(currentCtx==='savings'?'sv_txns':'ck_txns', arr);
      renderBalances(); renderAllTx();
      app.className = currentCtx==='savings'?'app pos-0':'app pos-1';
    }
  });

  /* ===== Add / Confirm / Balance sheets ===== */
  const addSheet=document.getElementById('addTxnSheet');
  const confirmSheet=document.getElementById('confirmSheet');
  const balSheet=document.getElementById('balSheet');

  // Icon hooks
  document.getElementById('svAdd').addEventListener('click', ()=> openAdd('savings'));
  document.getElementById('ckAdd').addEventListener('click', ()=> openAdd('checking'));
  document.getElementById('svBal').addEventListener('click', ()=> openChange('savings'));
  document.getElementById('ckBal').addEventListener('click', ()=> openChange('checking'));

  // Close handlers (dim and X)
  document.getElementById('addDim').addEventListener('click', ()=> closeSheet(addSheet));
  document.getElementById('addClose').addEventListener('click', ()=> closeSheet(addSheet));
  document.getElementById('txCancel').addEventListener('click', ()=> closeSheet(addSheet));
  document.getElementById('cfDim').addEventListener('click', ()=> closeSheet(confirmSheet));
  document.getElementById('cfClose').addEventListener('click', ()=> closeSheet(confirmSheet));
  document.getElementById('cfBack').addEventListener('click', ()=>{ closeSheet(confirmSheet); openSheet(addSheet,{instant:true}); });
  document.getElementById('balDim').addEventListener('click', ()=> closeSheet(balSheet));
  document.getElementById('balClose').addEventListener('click', ()=> closeSheet(balSheet));
  document.getElementById('balCancel').addEventListener('click', ()=> closeSheet(balSheet));

  const txMerchant=document.getElementById('txMerchant');
  const txAmount=document.getElementById('txAmount');
  const txWhen=document.getElementById('txWhen');
  const txType=document.getElementById('txType');
  const txStatus=document.getElementById('txStatus');
  const txContinue=document.getElementById('txContinue');

  function openAdd(ctx){
    currentCtx = ctx;
    txMerchant.value=''; txAmount.value=''; txType.value='debit'; txStatus.value='Complete';
    txWhen.value = nowLocalISO();
    openSheet(addSheet,{instant:true});
  }

  const cfSummary=document.getElementById('cfSummary');
  let pendingTxn=null;

  txContinue.addEventListener('click',(e)=>{
    e.stopPropagation();
    const m=(txMerchant.value||'').trim();
    const a=parseFloat(txAmount.value);
    const w=txWhen.value?new Date(txWhen.value):new Date();
    const t=txType.value==='credit'?'credit':'debit';
    const s=txStatus.value||'Complete';
    if(!m || !isFinite(a) || a<=0) return;

    const html = `
      <p><b>Merchant:</b> ${m}</p>
      <p><b>Amount:</b> ${t==='credit'?'+ ':'− '}${money(a)}</p>
      <p><b>Type:</b> ${t==='credit'?'Credit (+)':'Debit (−)'}</p>
      <p><b>Status:</b> ${s}</p>
      <p><b>Date &amp; Time:</b> ${w.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'})}, ${w.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'})}</p>
    `;
    cfSummary.innerHTML = html;
    openSheet(confirmSheet,{instant:true});  // open instantly
    requestAnimationFrame(()=> closeSheet(addSheet)); // then close add
    pendingTxn = { merchant:m, amount:+a.toFixed(2), iso:w.toISOString(), status:s, type:t };
  });

  document.getElementById('cfAdd').addEventListener('click',(e)=>{
    e.stopPropagation();
    if(!pendingTxn) return;
    const arr = (currentCtx==='savings') ? svTx : ckTx;
    const id='t_'+Math.random().toString(36).slice(2,9);
    const t = { id, ...pendingTxn };
    arr.push(t);
    if(currentCtx==='savings'){
      sv += (t.type==='credit' ? t.amount : -t.amount);
      localStorage.setItem('sv_bal', String(sv));
      saveTxns('sv_txns', arr); svTx = arr;
    }else{
      ck += (t.type==='credit' ? t.amount : -t.amount);
      localStorage.setItem('ck_bal', String(ck));
      saveTxns('ck_txns', arr); ckTx = arr;
    }
    renderBalances(); renderAllTx();
    pendingTxn=null; closeSheet(confirmSheet);
  });

  // Change balance
  const editBalance = document.getElementById('editBalance');
  function openChange(ctx){
    currentCtx = ctx;
    editBalance.value = (currentCtx==='savings'?sv:ck).toFixed(2);
    openSheet(balSheet,{instant:true});
  }
  document.getElementById('balSave').addEventListener('click', ()=>{
    const v = parseFloat(editBalance.value);
    if(!isFinite(v)) return;
    if(currentCtx==='savings'){ sv = +v.toFixed(2); localStorage.setItem('sv_bal',String(sv)); }
    else{ ck = +v.toFixed(2); localStorage.setItem('ck_bal',String(ck)); }
    renderBalances(); closeSheet(balSheet);
  });
})();
</script>
</body>
</html>
