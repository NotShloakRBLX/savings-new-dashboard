<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bank • Savings & Checking</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#141414;
    --panel2:#101010;
    --text:#eaeaea;
    --muted:#a9a9a9;
    --border:rgba(255,255,255,.12);
    --tile:rgba(255,255,255,.05);
    --tileBorder:rgba(255,255,255,.10);
    --blue:#0f2b4d;
    --t:.35s cubic-bezier(.2,.8,.2,1);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:#000;color:var(--text);
    font:15px -apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    font-weight:500;
    -webkit-font-smoothing:auto; text-rendering:optimizeSpeed;
    -webkit-tap-highlight-color: transparent;
  }
  .app{max-width:430px;height:100svh;margin:0 auto;position:relative;overflow:hidden;background:var(--bg)}
  /* 3 views: savings, checking, txn details */
  .views{display:flex;width:300%;height:100%;transition:transform var(--t)}
  .view{width:100%;height:100%;overflow:auto;background:linear-gradient(#0b0b0b,#0a0a0a 60%,#090909)}
  .view::-webkit-scrollbar{width:0;height:0}

  .nav{
    position:sticky;top:0;z-index:5;
    padding:12px 12px 8px;
    background:linear-gradient(180deg,rgba(10,10,10,.96),rgba(10,10,10,.62) 50%,transparent);
    -webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);
    display:flex;align-items:center;justify-content:space-between;
  }
  .bankTab{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--blue);border:1px solid rgba(255,255,255,.18);
    color:#fff;padding:10px 12px;border-radius:10px;letter-spacing:.2px;
  }
  .bankTab .dot{width:8px;height:8px;border-radius:50%;background:#6db1ff;opacity:.9}

  /* Sapphire-style small round icon buttons (replace gear) */
  .iconrow{display:flex;gap:10px}
  .iconbtn{width:34px;height:34px;border-radius:999px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);display:grid;place-items:center;transition:transform var(--t);cursor:pointer}
  .iconbtn:active{transform:scale(.96)}

  .content{padding:12px 12px 28px}

  .balHead{
    display:flex;justify-content:space-between;align-items:flex-end;
    gap:12px;padding:14px;border-radius:12px;background:var(--panel);border:1px solid var(--border)
  }
  .bhCol{min-width:0}
  .label{color:var(--muted);font-size:12px}
  .amt{font-size:30px;line-height:1.05}

  /* hide “Present balance” column on the top cards */
  .presentCol{display:none}

  .apy{display:inline-block;margin-top:10px;padding:6px 10px;border-radius:999px;
       background:var(--tile);border:1px solid var(--tileBorder);font-size:12px}

  .rowBtns{display:flex;gap:10px;margin-top:12px}
  .btn{
    flex:1;padding:14px 16px;border-radius:12px;border:1px solid var(--border);
    background:#efefef;color:#000;font-weight:500;cursor:pointer; touch-action: manipulation;
  }
  .btn.secondary{background:var(--panel2);color:#fff}

  .swapTile{margin-top:12px;padding:12px 14px;border-radius:12px;background:var(--tile);border:1px solid var(--tileBorder);cursor:pointer}
  .swapTop{display:flex;justify-content:space-between;align-items:center}
  .swapName{color:#dcdcdc}
  .swapAcct{color:#a9a9a9;font-size:12px;margin-top:2px}
  .swapAmt{font-size:18px}

  .section{margin-top:16px}
  .sectionTitle{font-size:16px;color:#dcdcdc;margin:0 2px 8px}
  .list{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .row{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
  .row + .row{border-top:1px solid var(--tileBorder)}
  .key{color:var(--muted)}
  .val{color:#fff}

  .moreBtnWrap{display:flex;justify-content:center;padding:12px}
  .moreBtn{
    border-radius:999px;border:1px solid var(--tileBorder);background:transparent;
    color:#dcdcdc;padding:10px 14px;font:inherit;cursor:pointer; touch-action: manipulation;
  }
  .chev{display:inline-block;margin-left:8px;transition:transform var(--t)}
  .open .chev{transform:rotate(180deg)}
  .moreWrap{display:none}
  .list.open .moreWrap{display:block}

  /* slide positions */
  .pos-0 .views{transform:translateX(0%)}        /* Savings */
  .pos-1 .views{transform:translateX(-33.3333%)} /* Checking */
  .pos-2 .views{transform:translateX(-66.6666%)} /* Txn details */

  .btn:active,.swapTile:active{transform:scale(.98);transition:transform var(--t)}

  /* ===== Sapphire-style transactions (no icons) ===== */
  .tile{background:var(--tile);border:1px solid var(--tileBorder);border-radius:8px;padding:14px 16px;position:relative}
  .kb{font-size:13px;color:var(--muted);margin:0 0 6px}
  .txnRow{display:flex;align-items:flex-start;gap:12px;background:transparent;border:0;border-radius:12px;padding:14px 0;cursor:pointer;position:relative}
  .txnRow + .txnRow{margin-top:0}
  .txnMain{flex:1}
  .txnTitle{font-weight:800}
  .txnSub{color:var(--muted);font-size:12px;margin-top:2px}
  .txnAmt{font-weight:600}
  .txnRight{display:flex;align-items:flex-start;gap:8px}
  .chevArrow{opacity:.55;font-size:20px;line-height:1;margin-top:1px}
  .txnStack{border:1px solid rgba(255,255,255,.10);border-radius:6px;overflow:hidden;background:rgba(255,255,255,.035);padding:0 16px}
  .txnStack .txnRow{padding:16px 0}
  .txnStack .txnRow + .txnRow::before{content:"";position:absolute;left:16px;right:16px;top:0;height:1px;background:rgba(255,255,255,.08)}
  .emptyTx{padding:14px 10px;color:var(--muted);font-size:13px}

  /* Txn details page */
  .pill{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:999px;padding:8px 14px}
  .center{padding:20px 16px 8px;text-align:center}
  .txnAmount{font-size:60px;font-weight:900;letter-spacing:-.5px}
  .txnMerchant{color:var(--muted);font-size:22px;font-weight:700;margin-top:6px}
  .txnDate{color:var(--muted);font-size:16px;margin-top:4px}
  .trow{margin:14px 12px;display:flex;justify-content:space-between;align-items:center;
        padding:16px;background:var(--tile);border:1px solid var(--tileBorder);border-radius:8px}
  .trow h3{margin:0;font-size:18px}
  .right{font-weight:900;font-size:18px}
  .statusLine{font-size:18px;margin-bottom:4px}
  .deleteWrap{padding:0 12px 24px}
  .deleteBtn{width:100%;border:0;border-radius:14px;padding:14px 18px;font-weight:900;background:#ff3b30;color:#fff}

  /* ===== Bottom sheets (copied style from card; dark) ===== */
  .sheet{position:fixed;inset:0;display:grid;place-items:end center;pointer-events:none;z-index:60}
  .sheet.active{pointer-events:auto}
  .dim{position:absolute;inset:0;background:rgba(0,0,0,.45);opacity:0;transition:opacity var(--t)}
  .sheet.active .dim{opacity:1}
  .panel{width:100%;max-width:430px;background:#111;color:#fff;border-radius:20px 20px 0 0;transform:translateY(100%);
    transition:transform var(--t);box-shadow:0 -20px 40px rgba(0,0,0,.35)}
  .sheet.active .panel{transform:translateY(0)}
  .panelHead{display:flex;align-items:center;justify-content:center;padding:12px 14px 0;position:relative}
  .closeX{position:absolute;left:14px;top:8px;width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#1f1f1f;color:#fff;font-size:20px;font-weight:900;cursor:pointer}
  .title{font-size:28px;font-weight:900;margin:6px 0 0;text-align:center}
  .form{padding:8px 14px 18px}
  .form label{display:block;font-weight:800;margin:12px 0 6px}
  .form input,.form select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;font:inherit}
  .actions{display:flex;justify-content:center;padding:0 14px 18px;gap:10px}
  .btnSheet{border-radius:14px;padding:14px 22px;font-weight:900;border:0;cursor:pointer}
  .btnPrimary{background:#fff;color:#000;min-width:65%}
  .btnGreen{background:#34c759;color:#000}
  .btnGray{background:#efefef;color:#000}
  .other{color:#0a84ff;text-align:center;font-weight:900;padding-bottom:20px}
</style>
</head>
<body>
<div class="app pos-0" id="app">
  <div class="views">

    <!-- ===== SAVINGS ===== -->
    <section class="view" id="savings">
      <div class="nav">
        <div class="bankTab"><span class="dot"></span>Bank Accounts</div>
        <div class="iconrow">
          <!-- Add Transaction -->
          <div class="iconbtn openAddTxn" data-ctx="savings" aria-label="Add Transaction">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path opacity=".9" d="M4 4h16v2H4zM4 9h16v2H4zM4 14h11v2H4zM4 19h11v2H4z"/></svg>
          </div>
          <!-- Change Balance -->
          <div class="iconbtn openBalances" data-ctx="savings" aria-label="Change Balance">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
          </div>
        </div>
      </div>
      <div class="content">

        <div class="balHead" aria-label="Savings balances">
          <div class="bhCol">
            <div class="label">Available balance</div>
            <div class="amt" id="svAvail">$783.11</div>
          </div>
          <div class="bhCol presentCol" style="text-align:right">
            <div class="label">Present balance</div>
            <div class="amt" id="svPresent">$783.11</div>
          </div>
        </div>

        <div class="apy">184% APR</div>

        <div class="rowBtns">
          <button class="btn">Pay</button>
          <button class="btn secondary" id="toTransfer1">Transfer</button>
        </div>

        <div class="swapTile" id="goChecking" aria-label="Open Checking">
          <div class="swapTop">
            <div>
              <div class="swapName">CHECKING (...2431)</div>
              <div class="swapAcct">Acct 375282431</div>
            </div>
            <div class="swapAmt" id="ckMini">$414.00</div>
          </div>
        </div>

        <div class="section">
          <h3 class="sectionTitle">Account details</h3>
          <div class="list" id="svDetails">
            <div class="row"><div class="key">Account number</div><div class="val">551809124</div></div>
            <div class="row"><div class="key">Routing number</div><div class="val">072000326</div></div>

            <div class="moreWrap">
              <div class="row"><div class="key">Available balance</div><div class="val" id="svAvailRow">$783.11</div></div>
              <div class="row"><div class="key">Present balance</div><div class="val" id="svPresentRow">$783.11</div></div>
              <div class="row"><div class="key">Interest rate</div><div class="val">184% APR</div></div>
              <div class="row"><div class="key">Next interest date</div><div class="val">08/31/2025</div></div>
              <div class="row"><div class="key">Next tax statement date</div><div class="val">08/27/2025</div></div>
            </div>

            <div class="moreBtnWrap">
              <button class="moreBtn" id="svMoreBtn" aria-expanded="false">
                Show more <span class="chev">▾</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Latest Transactions -->
        <div class="section">
          <div class="tile" id="svTxnsTile">
            <div class="kb" style="margin-bottom:8px">Latest Transactions</div>
            <div id="svTxnList"><div class="emptyTx">No transactions yet</div></div>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== CHECKING ===== -->
    <section class="view" id="checking">
      <div class="nav">
        <div class="bankTab"><span class="dot"></span>Bank Accounts</div>
        <div class="iconrow">
          <div class="iconbtn openAddTxn" data-ctx="checking" aria-label="Add Transaction">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path opacity=".9" d="M4 4h16v2H4zM4 9h16v2H4zM4 14h11v2H4zM4 19h11v2H4z"/></svg>
          </div>
          <div class="iconbtn openBalances" data-ctx="checking" aria-label="Change Balance">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
          </div>
        </div>
      </div>
      <div class="content">

        <div class="balHead" aria-label="Checking balances">
          <div class="bhCol">
            <div class="label">Available balance</div>
            <div class="amt" id="ckAvail">$414.00</div>
          </div>
          <div class="bhCol presentCol" style="text-align:right">
            <div class="label">Present balance</div>
            <div class="amt" id="ckPresent">$414.00</div>
          </div>
        </div>

        <div class="rowBtns">
          <button class="btn">Pay</button>
          <button class="btn secondary" id="toTransfer2">Transfer</button>
        </div>

        <div class="swapTile" id="goSavings" aria-label="Open Savings">
          <div class="swapTop">
            <div>
              <div class="swapName">SAVINGS (...9124)</div>
              <div class="swapAcct">Acct 551809124</div>
            </div>
            <div class="swapAmt" id="svMini">$783.11</div>
          </div>
        </div>

        <div class="section">
          <h3 class="sectionTitle">Account details</h3>
          <div class="list" id="ckDetails">
            <div class="row"><div class="key">Account number</div><div class="val">375282431</div></div>
            <div class="row"><div class="key">Routing number</div><div class="val">072000326</div></div>

            <div class="moreWrap">
              <div class="row"><div class="key">Available balance</div><div class="val" id="ckAvailRow">$414.00</div></div>
              <div class="row"><div class="key">Present balance</div><div class="val" id="ckPresentRow">$414.00</div></div>
              <div class="row"><div class="key">Interest rate</div><div class="val">0.00%</div></div>
              <div class="row"><div class="key">Interest in 2025</div><div class="val">$0.00</div></div>
            </div>

            <div class="moreBtnWrap">
              <button class="moreBtn" id="ckMoreBtn" aria-expanded="false">
                Show more <span class="chev">▾</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Latest Transactions -->
        <div class="section">
          <div class="tile" id="ckTxnsTile">
            <div class="kb" style="margin-bottom:8px">Latest Transactions</div>
            <div id="ckTxnList"><div class="emptyTx">No transactions yet</div></div>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== TRANSACTION DETAILS (shared) ===== -->
    <section class="view" id="txnView">
      <div class="nav">
        <button class="pill" id="backTxn">Back</button>
      </div>
      <div class="center">
        <div class="txnAmount" id="dAmount">$0.00</div>
        <div class="txnMerchant" id="dMerchant">Merchant</div>
        <div class="txnDate" id="dDate">MM/DD/YY, 0:00 PM</div>
      </div>
      <div class="tile" style="margin:14px 12px">
        <div class="statusLine" id="dStatus"><strong>Status: Complete</strong></div>
        <div class="kb" id="dCard">SAVINGS (...9124)</div>
      </div>
      <div class="trow"><h3>Total</h3><div class="right" id="dTotal">$0.00</div></div>
      <div class="deleteWrap"><button class="deleteBtn" id="deleteTxnBtn">Delete Transaction</button></div>
    </section>

  </div>
</div>

<!-- ===== Bottom sheets copied from Sapphire Reserve (tweaked) ===== -->

<!-- Add Transaction -->
<div class="sheet" id="addTxnSheet" aria-hidden="true">
  <div class="dim" id="addTxnDim"></div>
  <div class="panel">
    <div class="panelHead"><button class="closeX" id="closeAddTxn" aria-label="Close">×</button></div>
    <div class="title">Add Transaction</div>
    <div class="form">
      <label for="txMerchant">Merchant</label><input id="txMerchant" type="text" placeholder="e.g., Starbucks" />
      <label for="txAmount">Amount</label><input id="txAmount" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
      <label for="txWhen">Date &amp; Time</label><input id="txWhen" type="datetime-local" />
      <label for="txStatus">Status</label>
      <select id="txStatus"><option>Complete</option><option>Refunded</option></select>
    </div>
    <div class="actions">
      <button class="btnSheet btnGreen" id="txContinue">Continue</button>
      <button class="btnSheet btnGray" id="txCancelFromForm">Cancel</button>
    </div>
  </div>
</div>

<!-- Confirm Transaction -->
<div class="sheet" id="confirmTxnSheet" aria-hidden="true">
  <div class="dim" id="confirmDim"></div>
  <div class="panel">
    <div class="panelHead"><button class="closeX" id="closeConfirm" aria-label="Close">×</button></div>
    <div class="title">Confirm Transaction</div>
    <div class="form" id="confirmSummary"></div>
    <div class="actions">
      <button class="btnSheet btnPrimary" id="confirmAddBtn">Add Transaction</button>
      <button class="btnSheet btnGray" id="editTxnBtn">Go Back &amp; Edit</button>
    </div>
  </div>
</div>

<!-- Change Balance -->
<div class="sheet" id="balancesSheet" aria-hidden="true">
  <div class="dim" id="balancesDim"></div>
  <div class="panel">
    <div class="panelHead"><button class="closeX" id="closeBalances" aria-label="Close">×</button></div>
    <div class="title">Change Balance</div>
    <div class="form">
      <label for="editBalance">Balance</label>
      <input id="editBalance" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
    </div>
    <div class="actions">
      <button class="btnSheet btnGreen" id="balancesSaveBtn">Save</button>
      <button class="btnSheet btnGray" id="balancesCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
(() => {
  const app = document.getElementById('app');

  const DEFAULTS = { ver: 2, sv: 783.11, ck: 414.00 };
  const ver = Number(localStorage.getItem('acct_ver') || '0');
  if (ver !== DEFAULTS.ver) {
    localStorage.setItem('sv_bal', String(DEFAULTS.sv));
    localStorage.setItem('ck_bal', String(DEFAULTS.ck));
    localStorage.setItem('acct_ver', String(DEFAULTS.ver));
  }
  const money = n => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'});

  let sv = Number(localStorage.getItem('sv_bal') || DEFAULTS.sv);
  let ck = Number(localStorage.getItem('ck_bal') || DEFAULTS.ck);

  const svAvail = document.getElementById('svAvail');
  const svPresent = document.getElementById('svPresent');
  const svMini = document.getElementById('svMini');
  const svAvailRow = document.getElementById('svAvailRow');
  const svPresentRow = document.getElementById('svPresentRow');

  const ckAvail = document.getElementById('ckAvail');
  const ckPresent = document.getElementById('ckPresent');
  const ckMini = document.getElementById('ckMini');
  const ckAvailRow = document.getElementById('ckAvailRow');
  const ckPresentRow = document.getElementById('ckPresentRow');

  function renderBalances(){
    svAvail.textContent = money(sv);
    if (svPresent) svPresent.textContent = money(sv);
    if (svMini) svMini.textContent = money(sv);
    if (svAvailRow) svAvailRow.textContent = money(sv);
    if (svPresentRow) svPresentRow.textContent = money(sv);

    ckAvail.textContent = money(ck);
    if (ckPresent) ckPresent.textContent = money(ck);
    if (ckMini) ckMini.textContent = money(ck);
    if (ckAvailRow) ckAvailRow.textContent = money(ck);
    if (ckPresentRow) ckPresentRow.textContent = money(ck);
  }
  renderBalances();

  // slide nav between accounts
  document.getElementById('goChecking').addEventListener('click', () => { app.className = 'app pos-1'; });
  document.getElementById('goSavings').addEventListener('click',  () => { app.className = 'app pos-0'; });

  function setupMore(listId, btnId){
    const list = document.getElementById(listId);
    const btn  = document.getElementById(btnId);
    btn.addEventListener('click', ()=>{
      const open = list.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.innerHTML = open ? 'Hide details <span class="chev">▾</span>' : 'Show more <span class="chev">▾</span>';
    });
  }
  setupMore('svDetails','svMoreBtn');
  setupMore('ckDetails','ckMoreBtn');

  document.getElementById('toTransfer1').addEventListener('click', () => {});
  document.getElementById('toTransfer2').addEventListener('click', () => {});

  // ===== Transactions (lists + details) =====
  const SV_LAST4 = '9124';
  const CK_LAST4 = '2431';

  function cleanTxns(key){
    try{
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      const filtered = (Array.isArray(arr)?arr:[]).filter(t=>{
        const m = (t && typeof t.merchant !== 'undefined') ? String(t.merchant).trim() : '';
        return m && m.toLowerCase() !== 'undefined' && m.toLowerCase() !== 'null';
      });
      if (filtered.length !== (Array.isArray(arr)?arr.length:0)){
        localStorage.setItem(key, JSON.stringify(filtered));
      }
      return filtered;
    }catch(e){ return []; }
  }
  function loadTxns(key){ return cleanTxns(key); }
  let svTxns = loadTxns('sv_txns');
  let ckTxns = loadTxns('ck_txns');

  const svTxnListEl = document.getElementById('svTxnList');
  const ckTxnListEl = document.getElementById('ckTxnList');

  const shortDate = iso => { const d=new Date(iso); return d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'}) };

  function renderList(targetEl, arr, which){
    if (!arr.length){
      targetEl.innerHTML = '<div class="emptyTx">No transactions yet</div>';
      return;
    }
    const rows = arr
      .slice()
      .sort((a,b)=> new Date(b.iso) - new Date(a.iso))
      .map(t=>`
        <div class="txnRow" data-id="${t.id}" data-which="${which}">
          <div class="txnMain">
            <div class="txnTitle">${t.merchant}${t.status?` <span style="opacity:.6">• ${t.status}</span>`:''}</div>
            <div class="txnSub">${shortDate(t.iso)}</div>
          </div>
          <div class="txnRight">
            <div class="txnAmt">${money(Number(t.amount)||0)}</div>
            <div class="chevArrow">›</div>
          </div>
        </div>
      `).join('');
    targetEl.innerHTML = `<div class="txnStack">${rows}</div>`;
    targetEl.querySelectorAll('.txnRow').forEach(r=>{
      r.addEventListener('click',()=> openTxn(r.dataset.which, r.dataset.id));
    });
  }

  function renderTxnLists(){
    renderList(svTxnListEl, svTxns, 'savings');
    renderList(ckTxnListEl, ckTxns, 'checking');
  }
  renderTxnLists();

  // Details view
  const dAmount   = document.getElementById('dAmount');
  const dMerchant = document.getElementById('dMerchant');
  const dDate     = document.getElementById('dDate');
  const dStatus   = document.getElementById('dStatus');
  const dCard     = document.getElementById('dCard');
  const dTotal    = document.getElementById('dTotal');
  const backTxn   = document.getElementById('backTxn');
  const delBtn    = document.getElementById('deleteTxnBtn');
  let openCtx = null;

  function fullDateTime(iso){const d=new Date(iso);return d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'})+', '+d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'})}

  function openTxn(which,id){
    const list = which==='savings' ? svTxns : ckTxns;
    const t = list.find(x=>x.id===id);
    if(!t) return;
    dAmount.textContent   = money(Number(t.amount)||0);
    dMerchant.textContent = t.merchant || '';
    dDate.textContent     = fullDateTime(t.iso);
    dStatus.innerHTML     = `<strong>Status: ${t.status || 'Complete'}</strong>`;
    dCard.textContent     = which==='savings' ? `SAVINGS (...${SV_LAST4})` : `CHECKING (...${CK_LAST4})`;
    dTotal.textContent    = money(Number(t.amount)||0);
    openCtx = {which,id};
    app.className = 'app pos-2';
  }

  backTxn.addEventListener('click', ()=>{
    if(!openCtx) { app.className='app pos-0'; return; }
    app.className = (openCtx.which==='checking') ? 'app pos-1' : 'app pos-0';
  });

  delBtn.addEventListener('click', ()=>{
    if(!openCtx) return;
    if(openCtx.which==='savings'){
      const i = svTxns.findIndex(x=>x.id===openCtx.id);
      if(i>-1){ svTxns.splice(i,1); localStorage.setItem('sv_txns', JSON.stringify(svTxns)); }
    }else{
      const i = ckTxns.findIndex(x=>x.id===openCtx.id);
      if(i>-1){ ckTxns.splice(i,1); localStorage.setItem('ck_txns', JSON.stringify(ckTxns)); }
    }
    renderTxnLists();
    backTxn.click();
  });

  // ===== Bottom sheet flows (copied from card, tweaked) =====
  let actionCtx = null; // 'savings' | 'checking'

  // Openers
  document.querySelectorAll('.openAddTxn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      actionCtx = btn.dataset.ctx;
      openAddSheet();
    });
  });
  document.querySelectorAll('.openBalances').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      actionCtx = btn.dataset.ctx;
      openBalancesSheet();
    });
  });

  // --- Add Txn sheet
  const addTxnSheet=document.getElementById('addTxnSheet'),
        addTxnDim=document.getElementById('addTxnDim'),
        closeAddTxn=document.getElementById('closeAddTxn'),
        txMerchant=document.getElementById('txMerchant'),
        txAmount=document.getElementById('txAmount'),
        txWhen=document.getElementById('txWhen'),
        txStatus=document.getElementById('txStatus'),
        txContinue=document.getElementById('txContinue'),
        txCancelFromForm=document.getElementById('txCancelFromForm');

  function nowLocal(){ return new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,16); }
  function openAddSheet(){
    txMerchant.value=''; txAmount.value=''; txWhen.value=nowLocal(); txStatus.value='Complete';
    addTxnSheet.classList.add('active');
  }
  function closeAddSheet(){ addTxnSheet.classList.remove('active'); }
  addTxnDim.addEventListener('click',closeAddSheet); closeAddTxn.addEventListener('click',closeAddSheet);
  txCancelFromForm.addEventListener('click',closeAddSheet);

  // Confirm sheet
  const confirmSheet=document.getElementById('confirmTxnSheet'),
        confirmDim=document.getElementById('confirmDim'),
        closeConfirm=document.getElementById('closeConfirm'),
        confirmSummary=document.getElementById('confirmSummary'),
        confirmAddBtn=document.getElementById('confirmAddBtn'),
        editTxnBtn=document.getElementById('editTxnBtn');

  function openConfirm(){confirmSheet.classList.add('active')}
  function closeConfirmSheet(){confirmSheet.classList.remove('active')}
  confirmDim.addEventListener('click',closeConfirmSheet); closeConfirm.addEventListener('click',closeConfirmSheet);
  editTxnBtn.addEventListener('click',()=>{closeConfirmSheet();openAddSheet()});

  let pendingTxn=null;
  function fullDateTime2(iso){const d=new Date(iso);return d.toLocaleDateString(undefined,{month:'2-digit',day:'2-digit',year:'2-digit'})+', '+d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'})}

  txContinue.addEventListener('click',()=>{
    const m=(txMerchant.value||'').trim();
    const a=parseFloat(txAmount.value);
    const w=txWhen.value?new Date(txWhen.value):new Date();
    const s=txStatus.value||'Complete';
    if(!m||!isFinite(a))return;
    pendingTxn={merchant:m,amount:+a.toFixed(2),iso:w.toISOString(),status:s};
    confirmSummary.innerHTML=`<p><b>Merchant:</b> ${m}</p>
      <p><b>Amount:</b> $${pendingTxn.amount.toFixed(2)}</p>
      <p><b>Date &amp; Time:</b> ${fullDateTime2(pendingTxn.iso)}</p>
      <p><b>Status:</b> ${s}</p>`;
    closeAddSheet(); openConfirm();
  });

  function adjustBalance(which, amt, status){
    const delta = (status === 'Refunded') ? +amt : -amt; // refund adds back, complete subtracts
    if (which === 'savings'){
      sv = Math.round((sv + delta)*100)/100;
      localStorage.setItem('sv_bal', String(sv));
    } else {
      ck = Math.round((ck + delta)*100)/100;
      localStorage.setItem('ck_bal', String(ck));
    }
    renderBalances();
  }

  confirmAddBtn.addEventListener('click',()=>{
    if(!pendingTxn) return;
    const key = actionCtx === 'savings' ? 'sv_txns' : 'ck_txns';
    const list = JSON.parse(localStorage.getItem(key) || '[]');
    const t = { id:'t_'+Math.random().toString(36).slice(2,9), ...pendingTxn };
    list.push(t);
    localStorage.setItem(key, JSON.stringify(list));
    if(actionCtx==='savings'){ svTxns = list; } else { ckTxns = list; }
    adjustBalance(actionCtx, t.amount, t.status);
    renderTxnLists();
    pendingTxn=null; closeConfirmSheet();
  });

  // --- Change Balance sheet
  const balancesSheet=document.getElementById('balancesSheet'),
        balancesDim=document.getElementById('balancesDim'),
        closeBalances=document.getElementById('closeBalances'),
        balancesSaveBtn=document.getElementById('balancesSaveBtn'),
        balancesCancelBtn=document.getElementById('balancesCancelBtn'),
        editBalance=document.getElementById('editBalance');

  function openBalancesSheet(){
    editBalance.value = (actionCtx==='savings' ? sv : ck).toFixed(2);
    balancesSheet.classList.add('active');
  }
  function closeBalancesSheet(){ balancesSheet.classList.remove('active'); }
  balancesDim.addEventListener('click', closeBalancesSheet);
  closeBalances.addEventListener('click', closeBalancesSheet);
  balancesCancelBtn.addEventListener('click', closeBalancesSheet);

  balancesSaveBtn.addEventListener('click', ()=>{
    const n = parseFloat(editBalance.value);
    if (!isFinite(n) || n < 0) return;
    if (actionCtx === 'savings'){
      sv = +n.toFixed(2); localStorage.setItem('sv_bal', String(sv));
    }else{
      ck = +n.toFixed(2); localStorage.setItem('ck_bal', String(ck));
    }
    renderBalances();
    balancesSheet.classList.remove('active');
  });

})();
</script>
</body>
</html>
